---
sidebar_position: 6
description: çŠ¶æ€ç®¡ç†
---

## çŠ¶æ€ç®¡ç†

### 1\.å¯¹ Redux çš„ç†è§£ï¼Œä¸»è¦è§£å†³äº†ä»€ä¹ˆé—®é¢˜

React æ˜¯è§†å›¾å±‚æ¡†æ¶ã€‚Redux æ˜¯ä¸€ä¸ªç”¨æ¥**ç®¡ç†æ•°æ®çŠ¶æ€å’Œ UI çŠ¶æ€çš„ JavaScript åº”ç”¨å·¥å…·**ã€‚éšç€ JavaScript å•é¡µåº”ç”¨ï¼ˆSPAï¼‰å¼€å‘æ—¥è¶‹å¤æ‚ï¼Œ JavaScript éœ€è¦ç®¡ç†æ¯”ä»»ä½•æ—¶å€™éƒ½è¦å¤šçš„ stateï¼ˆçŠ¶æ€ï¼‰ï¼Œ Redux å°±æ˜¯é™ä½ç®¡ç†éš¾åº¦çš„ã€‚ï¼ˆRedux æ”¯æŒ Reactã€Angularã€jQuery ç”šè‡³çº¯ JavaScriptï¼‰ã€‚

åœ¨ React ä¸­ï¼ŒUI ä»¥ç»„ä»¶çš„å½¢å¼æ¥æ­å»ºï¼Œç»„ä»¶ä¹‹é—´å¯ä»¥åµŒå¥—ç»„åˆã€‚ä½† React ä¸­ç»„ä»¶é—´é€šä¿¡çš„æ•°æ®æµæ˜¯å•å‘çš„ï¼Œé¡¶å±‚ç»„ä»¶å¯ä»¥é€šè¿‡ props å±æ€§å‘ä¸‹å±‚ç»„ä»¶ä¼ é€’æ•°æ®ï¼Œè€Œä¸‹å±‚ç»„ä»¶ä¸èƒ½å‘ä¸Šå±‚ç»„ä»¶ä¼ é€’æ•°æ®ï¼Œå…„å¼Ÿç»„ä»¶ä¹‹é—´åŒæ ·ä¸èƒ½ã€‚è¿™æ ·ç®€å•çš„å•å‘æ•°æ®æµæ”¯æ’‘èµ·äº† React ä¸­çš„æ•°æ®å¯æ§æ€§ã€‚

**å½“é¡¹ç›®è¶Šæ¥è¶Šå¤§çš„æ—¶å€™ï¼Œç®¡ç†æ•°æ®çš„äº‹ä»¶æˆ–å›è°ƒå‡½æ•°å°†è¶Šæ¥è¶Šå¤šï¼Œä¹Ÿå°†è¶Šæ¥è¶Šä¸å¥½ç®¡ç†ã€‚ç®¡ç†ä¸æ–­å˜åŒ–çš„ state éå¸¸å›°éš¾ã€‚å¦‚æœä¸€ä¸ª model çš„å˜åŒ–ä¼šå¼•èµ·å¦ä¸€ä¸ª model å˜åŒ–ï¼Œé‚£ä¹ˆå½“ view å˜åŒ–æ—¶ï¼Œå°±å¯èƒ½å¼•èµ·å¯¹åº” model ä»¥åŠå¦ä¸€ä¸ª model çš„å˜åŒ–ï¼Œä¾æ¬¡åœ°ï¼Œå¯èƒ½ä¼šå¼•èµ·å¦ä¸€ä¸ª view çš„å˜åŒ–**ã€‚ç›´è‡³ä½ æä¸æ¸…æ¥šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚state åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œç”±äºä»€ä¹ˆåŸå› ï¼Œå¦‚ä½•å˜åŒ–å·²ç„¶ä¸å—æ§åˆ¶ã€‚ å½“ç³»ç»Ÿå˜å¾—é”™ç»¼å¤æ‚çš„æ—¶å€™ï¼Œæƒ³é‡ç°é—®é¢˜æˆ–è€…æ·»åŠ æ–°åŠŸèƒ½å°±ä¼šå˜å¾—ä¸¾æ­¥ç»´è‰°ã€‚å¦‚æœè¿™è¿˜ä¸å¤Ÿç³Ÿç³•ï¼Œè€ƒè™‘ä¸€äº›æ¥è‡ªå‰ç«¯å¼€å‘é¢†åŸŸçš„æ–°éœ€æ±‚ï¼Œå¦‚æ›´æ–°è°ƒä¼˜ã€æœåŠ¡ç«¯æ¸²æŸ“ã€è·¯ç”±è·³è½¬å‰è¯·æ±‚æ•°æ®ç­‰ã€‚state çš„ç®¡ç†åœ¨å¤§é¡¹ç›®ä¸­ç›¸å½“å¤æ‚ã€‚

Redux æä¾›äº†ä¸€ä¸ªå« store çš„ç»Ÿä¸€ä»“å‚¨åº“ï¼Œ**ç»„ä»¶é€šè¿‡ dispatch å°† state ç›´æ¥ä¼ å…¥ storeï¼Œä¸ç”¨é€šè¿‡å…¶ä»–çš„ç»„ä»¶ã€‚å¹¶ä¸”ç»„ä»¶é€šè¿‡ subscribe ä» store è·å–åˆ° state çš„æ”¹å˜ã€‚ä½¿ç”¨äº† Reduxï¼Œæ‰€æœ‰çš„ç»„ä»¶éƒ½å¯ä»¥ä» store ä¸­è·å–åˆ°æ‰€éœ€çš„ stateï¼Œä»–ä»¬ä¹Ÿèƒ½ä» store è·å–åˆ° state çš„æ”¹å˜**ã€‚è¿™æ¯”ç»„ä»¶ä¹‹é—´äº’ç›¸ä¼ é€’æ•°æ®æ¸…æ™°æ˜æœ—çš„å¤šã€‚

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å•å‘æ•°æ®æµçš„æ–¹å¼ï¼Œå› ä¸ºå‰ç«¯é¡¹ç›®æœ‰å¤§å¤šæ•°æ˜¯ mvc æˆ–è€…æ˜¯ mvvm æ¶æ„ã€‚è¿™ç§æ¶æ„æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Œæœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºç‚¹å°±æ˜¯ å½“ä¸šåŠ¡å¤æ‚åº¦å˜å¾—è¶Šæ¥è¶Šé«˜çš„æ—¶å€™ï¼Œå› ä¸ºå…è®¸ view å±‚å’Œ model å±‚ ç›´æ¥ä¼ é€’ã€‚å› ä¸º model å¯èƒ½ä¸æ­¢å¯¹åº”ä¸€ä¸ª view å±‚ï¼Œå°±ä¼šå‡ºç°ä¸‹å›¾è¿™æ ·çš„æƒ…å†µï¼š

![image-20220920221818343](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/image-20220920221818343.png)

ä»å›¾ä¸Šçœ‹æ•°æ®æµè¿™æ˜¯æ··ä¹±çš„ï¼Œå¦‚æœé¡¹ç›®ä¸­å‡ºç° bug å°±å¾ˆéš¾å®šä½åˆ°åˆ°åº•æ˜¯å“ªä¸€æ­¥å‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥ Redux çš„æ ¸å¿ƒæ˜¯**å•å‘æ•°æ®æµï¼Œ å› ä¸ºè§†å›¾æ›´æ–°å°±æ˜¯ä» store é€šçŸ¥è§†å›¾æ›´æ–°**

**ä¸»è¦è§£å†³çš„é—®é¢˜ï¼š** **å•çº¯çš„ Redux åªæ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œæ˜¯æ²¡æœ‰ UI å‘ˆç°çš„ï¼Œreact- redux ä½œç”¨æ˜¯å°† Redux çš„çŠ¶æ€æœºå’Œ React çš„ UI å‘ˆç°ç»‘å®šåœ¨ä¸€èµ·**ï¼Œå½“ä½  dispatch action æ”¹å˜ state çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æ›´æ–°é¡µé¢ã€‚

### 2.Redux ä¸ React-Redux

redux æ˜¯ä¸€ä¸ªåº”ç”¨æ•°æ®æµæ¡†æ¶ï¼Œä¸»è¦æ˜¯è§£å†³äº†ç»„ä»¶é—´çŠ¶æ€å…±äº«çš„é—®é¢˜ï¼ŒåŸç†æ˜¯é›†ä¸­å¼ç®¡ç†ã€‚

React-redux æ˜¯ä¸ºæ–¹ä¾¿ react ä½¿ç”¨ï¼Œåœ¨ redux ä¸Šå°è£…çš„åº“ã€‚åœ¨å®é™…çš„é¡¹ç›®ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ redux ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ react-reduxã€‚

#### 1.redux

##### 1.redux çš„æ¦‚å¿µ

redux å’Œ react ä¹‹é—´æ˜¯æ²¡æœ‰å…³ç³»çš„ï¼ŒRedux æ”¯æŒ Reactã€angularã€jQuery ç”šè‡³ Javascript

redux æ˜¯ä¸€ä¸ªåº”ç”¨æ•°æ®æµæ¡†æ¶ï¼Œä¸»è¦æ˜¯è§£å†³äº†ç»„ä»¶é—´çŠ¶æ€å…±äº«çš„é—®é¢˜ï¼ŒåŸç†æ˜¯é›†ä¸­å¼ç®¡ç†ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œ`actionï¼Œstoreï¼Œreducer`

**(1)å•ä¸€æ•°æ®æº**

**(2)state æ˜¯åªè¯»çš„**

å”¯ä¸€æ”¹å˜ state çš„æ–¹æ³•å°±æ˜¯è§¦å‘ action,action æ˜¯ä¸€ä¸ªç”¨äºæè¿°å·²ç»å‘ç”Ÿäº‹ä»¶çš„æ™®é€šå¯¹è±¡

```js
store.dispatch({ type: "COMPLETE_TODO", index: 1 });
```

**(3)ä½¿ç”¨çº¯å‡½æ•°æ¥æ‰§è¡Œä¿®æ”¹**

ä¸ºäº†æè¿° action å¦‚ä½•ä¿®æ”¹ state treeï¼Œä½ éœ€è¦å»ç¼–å†™ reducers

Reducers åªæ˜¯ä¸€äº›çº¯å‡½æ•°ï¼Œå®ƒæ¥æ”¶å…ˆå‰çš„ state å’Œ action,å¹¶ä¸”è¿”å›æ–°çš„ state.å¯ä»¥å¤ç”¨ã€å¯ä»¥æ§åˆ¶é¡ºåºã€ä¼ å…¥é™„åŠ å‚æ•°

##### 2.redux çš„ç»„æˆ

state:å°±æ˜¯æˆ‘ä»¬ä¼ é€’çš„æ•°æ®ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼šDomainDataã€UI Stateã€App State

**(1)Action:**å°†æˆ‘ä»¬çš„æ•°æ®ä»åº”ç”¨ä¼ é€’åˆ° store çš„è½½ä½“ï¼Œå®ƒæ˜¯ store æ•°æ®çš„å”¯ä¸€æ¥æºã€‚æˆ‘ä»¬å¯é€šè¿‡ store.dispatch()å°† action ä¼ é€’ç»™ store

```js
{
 type:'USE_LIST',//å¿…é¡»å­—æ®µ
 list:{...}
 }
// actionåªæ˜¯æè¿°æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¹¶ä¸æ›´æ–°state

//actionçš„åˆ›å»ºå‡½æ•°
function addAction(params){
	return{
		type:'add',
		...params
	}
}
```

**(2)Reducer:**æœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥å“åº”å‘é€è¿‡æ¥çš„ actions,ç»å¤„ç†å°† state å‘ç”Ÿç»™ store

æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šä¸€æ˜¯åˆå§‹åŒ– state,äºŒæ˜¯ action

```js
const initState = {...}
rootReducer = (state = initState,action)=>{...return{...}}
```

**(3)Store**ä½œä¸º action å’Œ reducer çš„æ¡¥æ¢

```js
import { createStore } from "redux";
const store = createStore(ä¼ é€’reducer);
```

æ‹¥æœ‰ä»¥ä¸‹å±æ€§å’Œæ–¹æ³•ï¼š

| State     | åº”ç”¨çš„æ•°æ®çŠ¶æ€                       |
| --------- | ------------------------------------ |
| getState  | è·å–æ•°æ®çŠ¶æ€                         |
| Dispatch  | å‘é€ action                          |
| Subscribe | æ³¨å†Œç›‘å¬ï¼ŒSubscribe çš„è¿”å›å€¼æ³¨é”€ç›‘å¬ |

redux çš„ä½¿ç”¨ä¾‹å­ï¼š

**1.åˆ›å»º store/index.js**

store å°±æ˜¯ä¿å­˜æ•°æ®çš„åœ°æ–¹ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå®¹å™¨ã€‚

```js
import { createStore } from "redux";
//å¯¼å…¥å·²ç»åˆ›å»ºçš„reducer
import { reducer } from "../reducer";
export default createStore(reducer);
```

**2.åˆ›å»º action/index.js**

Action å°±æ˜¯ View å‘å‡ºçš„é€šçŸ¥ï¼Œè¡¨ç¤º State åº”è¯¥è¦å‘ç”Ÿå˜åŒ–äº†ã€‚

Action æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å…¶ä¸­çš„`type`å±æ€§æ˜¯å¿…é¡»çš„ï¼Œè¡¨ç¤º Action çš„åç§°ã€‚å…¶ä»–å±æ€§å¯ä»¥è‡ªç”±è®¾ç½®.

```js
const sendAction = () => {
  return {
    type: "send_action",
    value: "å‘é€äº†æŸä¸ªæ•°æ®â€”â€”--",
  };
};
module.exports = {
  sendAction,
};
```

**3.åˆ›å»º reducer/index.js**

store æ”¶åˆ° action ä»¥åï¼Œä¼šç»™ä¸€ä¸ªæ–°çš„ Stateï¼Œè¿™æ · View æ‰ä¼šå‘ç”Ÿå˜åŒ–ã€‚è¿™ç§ State çš„è®¡ç®—è¿‡ç¨‹å°±å«åš Reducerã€‚

```js
//ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºstate,æˆ‘ä»¬å¯ä»¥å®šä¹‰é»˜è®¤å€¼ï¼Œç„¶åè¿›è¡Œèµ‹å€¼
//åœ¨å‡½æ•°ä¸­åˆ¤æ–­ç¬¬äºŒä¸ªå‚æ•°actionçš„typeå€¼æ˜¯å¦æ˜¯æˆ‘ä»¬å‘é€çš„ï¼Œæ˜¯åˆ™é€šè¿‡returnè¿”å›æ–°çš„state,
//å°†reducerå¯¼å‡º
/**
 * ä¸“é—¨å¤„ç†å‘é€è¿‡æ¥çš„action
 */
const reducer = (state = { value: "é»˜è®¤å€¼" }, action) => {
  console.log("reducer", state, action);
  switch (action.type) {
    case "send_action":
      return Object.assign({}, state, action);
    default:
      return state;
  }
};

module.exports = {
  reducer,
};
```

**4.åœ¨ç»„ä»¶ä¸­çš„ä½¿ç”¨**

```js
import { Button } from "antd";
import React, { Component } from "react";
import store from "../../store";
import { sendAction } from "../../action";
class UrlList extends Component {
  constructor(props) {
    super(props);
    //ä¹Ÿå¯ä»¥ä½¿ç”¨ç®­å¤´å‡½æ•°å“ˆ
    this.handleClick = this.handleClick.bind(this);
  }
  handleClick() {
    const action = sendAction();
    store.dispatch(action);
  }
  //å½“ç»„ä»¶åŠ è½½å®Œæ¯•æ¥ç›‘å¬
  componentDidMount() {
    console.log(this.context.router);
    store.subscribe(() => {
      //é€šè¿‡store.getState().valueæ¥è·å–stateä¸­çš„å€¼
      console.log("subscribe", store.getState().value);
      this.setState({});
    });
  }

  render() {
    return (
      <>
        <Button onClick={this.handleClick}>æŒ‰é’®å‘é€</Button>
        <h1>{store.getState().value}</h1>
      </>
    );
  }
}
export default Com;
```

#### 2.react-redux

React-redux ä¸­çš„ä¸¤ä¸ªæ ¸å¿ƒæˆå‘˜ï¼šProviderã€Connect

Provider:è¿™ä¸ªç»„ä»¶ä½¿å¾—æ•´ä¸ª app éƒ½èƒ½è·å–åˆ° store ä¸­çš„æ•°æ®

Connect:ä½¿å¾—**ç»„ä»¶èƒ½å¤Ÿè·Ÿ store å…³è”**

##### provider

- Provider åŒ…è£…åœ¨æ ¹ç»„ä»¶çš„æœ€å¤–å±‚ï¼Œä½¿å¾—æ‰€æœ‰ç»„ä»¶éƒ½å¯ä»¥æ‹¿åˆ° state
- Provider æ¥æ”¶ state ä½œä¸º props,é€šè¿‡ context å¾€ä¸‹ä¼ é€’ï¼Œè¿™æ · react ä¸­ä»»ä½•ç»„ä»¶éƒ½å¯ä»¥é€šè¿‡ context è·å– store

##### connect

- Provider å†…éƒ¨ç»„ä»¶å¦‚æœæƒ³è¦ä½¿ç”¨åˆ° state ä¸­çš„æ•°æ®ï¼Œå°±å¿…é¡»è¦ connect è¿›è¡Œå±‚åŒ…è£¹å°è£…ï¼Œæ¢-å¥è¯æ¥è¯´å°±æ˜¯å¿…é¡»è¦è¢« connect è¿›è¡ŒåŠ å¼º
- connect å°±æ˜¯æ–¹ä¾¿æˆ‘ä»¬ç»„ä»¶èƒ½å¤Ÿè·å–åˆ° store ä¸­çš„ state

##### ä½¿ç”¨

###### ï¼ˆ1ï¼‰react-redux çš„å®‰è£…ï¼š

yarn add redux

yarn add react-redux

###### ï¼ˆ2ï¼‰æ„å»º store å’Œ reducer

1.åˆ›å»º reducer/index.js æ–‡ä»¶ï¼Œæ„å»º reducer æ¥å“åº” actions

```react
//render/index.js
//ä¸€ã€state äºŒã€action
let initState={
    count:0
}
exports.reducer = (state = initState, action) => {
    switch (action.type) {
        case 'send_action':
            return {
                count:state.count+1
            }
        default:
            return state;
    }
}
```

2.åˆ›å»º store/index.js æ–‡ä»¶ï¼Œé€šè¿‡ createStore æ–¹æ³•ï¼ŒæŠŠæˆ‘ä»¬çš„ reducer ä¼ å…¥è¿›æ¥

```react
import { createStore } from "redux";
//å¯¼å…¥å·²ç»åˆ›å»ºçš„reducer
import {reducer} from '../reducer'
export default createStore(reducer)
```

###### (3)Provider çš„å®ç°

1.å¯¼å…¥ Provider ç»„ä»¶ï¼Œåœ¨ react-redux ä¸­è¿›è¡Œå¯¼å…¥

2.éœ€è¦åˆ©ç”¨ Provider ç»„ä»¶ï¼Œå¯¹æˆ‘ä»¬æ•´ä¸ªç»“æ„è¿›è¡ŒåŒ…è£¹

3.ç»™æˆ‘ä»¬ Provider ç»„ä»¶è®¾ç½® store çš„å±æ€§ï¼Œè€Œè¿™ä¸ªå±æ€§å€¼æ˜¯é€šè¿‡ createStore æ„å»ºå‡ºçš„ store å®ä¾‹å¯¹è±¡

```react
import './App.css';
import ComA from './pages/ComA'
import ComB from './pages/ComB'
import store from "./store";
import { Provider } from 'react-redux';
function App() {
  return (
    <Provider store={store}>
          <ComA/>
          <ComB/>
      </Provider>
  );
}

export default App;
```

###### (4)connect

å¯¹ connect ç®€å•åˆ†æä¸€ä¸‹

mapStateToProps æ–¹æ³•ï¼š`connect` çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„ï¼Œè€Œä¸”ä¼šåœ¨æ¯æ¬¡`store`ä¸­çš„ state æ”¹å˜æ—¶è°ƒç”¨ã€‚ç”¨æˆ·è·å– state ä¸­çš„æ•°æ®,å¿…é¡»æœ‰è¿”å›å€¼ï¼ˆæ™®é€šå¯¹è±¡ï¼‰ã€‚

| å‚æ•°     | å¤‡æ³¨                 |
| -------- | -------------------- |
| state    | å¿…ä¼                  |
| ownProps | éå¿…ä¼ ï¼Œè‡ªå·±çš„ props |

mapDispatchToPropsï¼š`connect` çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥çš„ï¼Œç”¨äºå°†æ“ä½œåˆ†é…ç»™ store.

`dispatch` æ˜¯ Redux store çš„ä¸€ä¸ªå‡½æ•°ã€‚ä½ è°ƒç”¨ store.dispatch æ¥è°ƒåº¦ä¸€ä¸ªåŠ¨ä½œã€‚è¿™æ˜¯è§¦å‘çŠ¶æ€æ›´æ”¹çš„å”¯ä¸€æ–¹æ³•ã€‚

ç¬¬ä¸‰ä¸ªæ˜¯è¦åŠ å¼ºçš„ç»„ä»¶

```js
Connect(mapStateToProps, mapDispatchToProps)(è¦åŠ å¼ºçš„ç»„ä»¶);
```

##### æ¡ˆä¾‹ï¼š

æˆ‘ä»¬å®ç°ä»åœ¨ ComB ä¸­ç‚¹å‡»æŒ‰é’®+1,åœ¨ ComA ä¸­è·å–+1 åçš„å€¼ã€‚

æ‰€ä»¥è¯´ ComB æ˜¯å‘é€æ–¹ï¼ŒComA æ˜¯æ¥æ”¶æ–¹ã€‚

å®ç°æ­¥éª¤ï¼š

1.å¯¼å…¥ connect

2.åˆ©ç”¨ connect å¯¹ç»„ä»¶è¿›è¡ŒåŠ å¼º

```react
import React, {Component}  from "react";
import {connect} from 'react-redux'
class ComB extends Component{
    handleClick=()=>{
        console.log('ComB',this.props)
        this.props.sendAction()
    }

    render(){
        return (
            <>
            <button onClick={this.handleClick}>æŒ‰é’®+1</button>
            </>
        )
    }

}
const mapDispatchToProps = (dispatch)=>{
    return {
      //å°†sendActionæ³¨å†Œåˆ°ComBçš„propsä¸­ï¼Œç„¶åå°±ç›´æ¥åœ¨ComBä¸­ç›´æ¥ä½¿ç”¨this.props.sendAction()
        sendAction:()=>{
            dispatch({
                type:'send_action'
            })
        }
    }
}

export default connect(null,mapDispatchToProps)(ComB)
//connect(null,mapDispatchToProps)(ComB)

ç¬¬ä¸€ä¸ªå‚æ•°ï¼šè¦æ¥æ”¶çš„å‡½æ•°
ç¬¬äºŒä¸ªå‚æ•°ï¼šè¦å‘é€actionçš„å‡½æ•°
ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šåé¢çš„æ‹¬å·é‡Œé¢æ˜¯è¦åŠ å¼ºçš„ç»„ä»¶
```

3.åœ¨ ComA çš„ç»„ä»¶æ–¹æ³•ä¸­å¯ä»¥é€šè¿‡ this.props æ‹¿åˆ° sendAction

```react
import React, {Component}  from "react";
import { connect } from "react-redux";

class ComA extends Component{
    render(){
        console.log('Home render',this.props)
        return (
            <>
           <div>
           {this.props.count}
           </div>
            </>
        )
    }

}
const mapstateToProps = (state)=>{
    console.log('Home',state)
    return state;
}
export default connect(mapstateToProps)(ComA)
//ç®€å†™ï¼š
//export default connect((state)=>state)(ComA)
```

å¤§æ¦‚æ€»ç»“ä¸€ä¸‹æ•´ä¸ªæµç¨‹ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/674b80c5fdac4f2f9e6252590b22276f.png)

### 3.Redux åŸç†åŠå·¥ä½œæµç¨‹

![reduxåŸç†å›¾](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/imgsredux%E5%8E%9F%E7%90%86%E5%9B%BE.png)

#### **ï¼ˆ1ï¼‰åŸç†**

Redux æºç ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ¨¡å—æ–‡ä»¶

- compose.js æä¾›ä»å³åˆ°å·¦è¿›è¡Œå‡½æ•°å¼ç¼–ç¨‹
- createStore.js æä¾›ä½œä¸ºç”Ÿæˆå”¯ä¸€ store çš„å‡½æ•°
- combineReducers.js æä¾›åˆå¹¶å¤šä¸ª reducer çš„å‡½æ•°ï¼Œä¿è¯ store çš„å”¯ä¸€æ€§
- bindActionCreators.js å¯ä»¥è®©å¼€å‘è€…åœ¨ä¸ç›´æ¥æ¥è§¦ dispacth çš„å‰æä¸‹è¿›è¡Œæ›´æ”¹ state çš„æ“ä½œ
- applyMiddleware.js è¿™ä¸ªæ–¹æ³•é€šè¿‡ä¸­é—´ä»¶æ¥å¢å¼º dispatch çš„åŠŸèƒ½

```jsx
const actionTypes = {
    ADD: 'ADD',
    CHANGEINFO: 'CHANGEINFO',
}

const initState = {
    info: 'åˆå§‹åŒ–',
}

export default function initReducer(state=initState, action) {
    switch(action.type) {
        case actionTypes.CHANGEINFO:
            return {
                ...state,
                info: action.preload.info || '',
            }
        default:
            return { ...state };
    }
}

export default function createStore(reducer, initialState, middleFunc) {

    if (initialState && typeof initialState === 'function') {
        middleFunc = initialState;
        initialState = undefined;
    }

    let currentState = initialState;

    const listeners = [];

    if (middleFunc && typeof middleFunc === 'function') {
        // å°è£…dispatch
        return middleFunc(createStore)(reducer, initialState);
    }

    const getState = () => {
        return currentState;
    }

    const dispatch = (action) => {
        currentState = reducer(currentState, action);

        listeners.forEach(listener => {
            listener();
        })
    }

    const subscribe = (listener) => {
        listeners.push(listener);
    }

    return {
        getState,
        dispatch,
        subscribe
    }
}

```

#### **ï¼ˆ2ï¼‰å·¥ä½œæµç¨‹**

- const store= createStoreï¼ˆfnï¼‰ç”Ÿæˆæ•°æ®;
- action: {type: Symble('action01), payload:'payload' }å®šä¹‰è¡Œä¸º;
- dispatch å‘èµ· actionï¼šstore.dispatch(doSomething('action001'));
- reducerï¼šå¤„ç† actionï¼Œè¿”å›æ–°çš„ state;

**é€šä¿—ç‚¹è§£é‡Šï¼š**

- é¦–å…ˆï¼Œç”¨æˆ·ï¼ˆé€šè¿‡ Viewï¼‰å‘å‡º Actionï¼Œå‘å‡ºæ–¹å¼å°±ç”¨åˆ°äº† dispatch æ–¹æ³•
- ç„¶åï¼ŒStore è‡ªåŠ¨è°ƒç”¨ Reducerï¼Œå¹¶ä¸”ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼šå½“å‰ State å’Œæ”¶åˆ°çš„ Actionï¼ŒReducer ä¼šè¿”å›æ–°çš„ State
- Stateâ€”æ—¦æœ‰å˜åŒ–ï¼ŒStore å°±ä¼šè°ƒç”¨ç›‘å¬å‡½æ•°ï¼Œæ¥æ›´æ–° View
-

ä»¥ store ä¸ºæ ¸å¿ƒï¼Œå¯ä»¥æŠŠå®ƒçœ‹æˆæ•°æ®å­˜å‚¨ä¸­å¿ƒï¼Œä½†æ˜¯ä»–è¦æ›´æ”¹æ•°æ®çš„æ—¶å€™ä¸èƒ½ç›´æ¥ä¿®æ”¹ï¼Œæ•°æ®ä¿®æ”¹æ›´æ–°çš„è§’è‰²ç”± Reducers æ¥æ‹…ä»»ï¼Œstore åªåšå­˜å‚¨ï¼Œä¸­é—´äººï¼Œå½“ Reducers çš„æ›´æ–°å®Œæˆä»¥åä¼šé€šè¿‡ store çš„è®¢é˜…æ¥é€šçŸ¥ react componentï¼Œç»„ä»¶æŠŠæ–°çš„çŠ¶æ€é‡æ–°è·å–æ¸²æŸ“ï¼Œç»„ä»¶ä¸­ä¹Ÿèƒ½ä¸»åŠ¨å‘é€ actionï¼Œåˆ›å»º action åè¿™ä¸ªåŠ¨ä½œæ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¦ dispatch è¿™ä¸ª actionï¼Œè®© store é€šè¿‡ reducers å»åšæ›´æ–° React Component å°±æ˜¯ react çš„æ¯ä¸ªç»„ä»¶ã€‚

#### å•å‘æ•°æ®æµ

![Reduxæ•°æ®æµå‘å›¾](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/3/8/170b7ee3c499efaa~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

å›¾ä¸­å®¹æ˜“çœ‹å‡ºæ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯ä»¥ store ä¸ºæ ¸å¿ƒ,æˆ‘ä»¬æŠŠå®ƒçœ‹æˆæ•°æ®å­˜å‚¨ä¸­å¿ƒ,ä½†æ˜¯ä»–è¦æ›´æ”¹æ•°æ®çš„æ—¶å€™ä¸èƒ½ç›´æ¥ä¿®æ”¹,æ•°æ®ä¿®æ”¹**æ›´æ–°çš„è§’è‰²ç”± Reducers æ¥æ‹…ä»»**, **store åªåšå­˜å‚¨,ä¸­é—´äºº**,å½“**Reducers çš„æ›´æ–°å®Œæˆ**ä»¥åä¼šé€šè¿‡**store çš„è®¢é˜…æ¥é€šçŸ¥ react component** ,ç»„ä»¶è·å–æ–°çš„çŠ¶æ€ï¼Œè¿›è¡Œé‡æ–°æ¸²æŸ“,ç»„ä»¶ä¸­æˆ‘ä»¬ä¹Ÿèƒ½**ä¸»åŠ¨å‘é€ action,**åˆ›å»º action åè¿™ä¸ªåŠ¨ä½œæ˜¯ä¸ä¼šæ‰§è¡Œçš„,æ‰€ä»¥è¦ dispatch è¿™ä¸ª action,è®©**store é€šè¿‡ reducers å»åšæ›´æ–°** React Component å°±æ˜¯ react çš„æ¯ä¸ªç»„ä»¶

### 4.Redux ä¸­å¼‚æ­¥çš„è¯·æ±‚æ€ä¹ˆå¤„ç†

å¯ä»¥åœ¨ componentDidmount ä¸­ç›´æ¥è¿›â¾è¯·æ±‚â½†é¡»å€ŸåŠ© reduxã€‚ä½†æ˜¯åœ¨â¼€å®šè§„æ¨¡çš„é¡¹â½¬ä¸­,ä¸Šè¿°â½…æ³•å¾ˆéš¾è¿›â¾å¼‚æ­¥æµçš„ç®¡ç†,é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¼šå€ŸåŠ©**redux çš„å¼‚æ­¥ä¸­é—´ä»¶**è¿›â¾å¼‚æ­¥å¤„ç†ã€‚redux å¼‚æ­¥æµä¸­é—´ä»¶å…¶å®æœ‰å¾ˆå¤šï¼Œå½“ä¸‹ä¸»æµçš„å¼‚æ­¥ä¸­é—´ä»¶æœ‰ä¸¤ç§ redux-thunkã€redux-sagaã€‚

#### **ä½¿ç”¨ react-thunk ä¸­é—´ä»¶**

**redux-thunk**ä¼˜ç‚¹:

- ä½“ç§¯â¼©: redux-thunk çš„å®ç°â½…å¼å¾ˆç®€å•,åªæœ‰ä¸åˆ° 20 â¾ä»£ç 
- ä½¿â½¤ç®€å•: redux-thunk æ²¡æœ‰å¼•â¼Šåƒ redux-saga æˆ–è€… redux-observable é¢å¤–çš„èŒƒå¼,ä¸Šâ¼¿ç®€å•

**redux-thunk**ç¼ºé™·:

- æ ·æ¿ä»£ç è¿‡å¤š: ä¸ redux æœ¬èº«â¼€æ ·,é€šå¸¸â¼€ä¸ªè¯·æ±‚éœ€è¦â¼¤é‡çš„ä»£ç ,â½½ä¸”å¾ˆå¤šéƒ½æ˜¯é‡å¤æ€§è´¨çš„
- è€¦åˆä¸¥é‡: å¼‚æ­¥æ“ä½œä¸ redux çš„ action å¶åˆåœ¨â¼€èµ·,ä¸â½…ä¾¿ç®¡ç†
- åŠŸèƒ½å­±å¼±: æœ‰â¼€äº›å®é™…å¼€å‘ä¸­å¸¸â½¤çš„åŠŸèƒ½éœ€è¦â¾ƒâ¼°è¿›â¾å°è£…

ä½¿ç”¨æ­¥éª¤ï¼š

- é…ç½®ä¸­é—´ä»¶ï¼Œåœ¨ store çš„åˆ›å»ºä¸­é…ç½®

```jsx
import { createStore, applyMiddleware, compose } from "redux";
import reducer from "./reducer";
import thunk from "redux-thunk";

// è®¾ç½®è°ƒè¯•å·¥å…·
const composeEnhancers = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__
  ? window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({})
  : compose;
// è®¾ç½®ä¸­é—´ä»¶
const enhancer = composeEnhancers(applyMiddleware(thunk));

const store = createStore(reducer, enhancer);

export default store;
```

- æ·»åŠ ä¸€ä¸ªè¿”å›å‡½æ•°çš„ actionCreatorï¼Œå°†å¼‚æ­¥è¯·æ±‚é€»è¾‘æ”¾åœ¨é‡Œé¢

```jsx
/**
  å‘é€getè¯·æ±‚ï¼Œå¹¶ç”Ÿæˆç›¸åº”actionï¼Œæ›´æ–°storeçš„å‡½æ•°
  @param url {string} è¯·æ±‚åœ°å€
  @param func {function} çœŸæ­£éœ€è¦ç”Ÿæˆçš„actionå¯¹åº”çš„actionCreator
  @return {function} 
*/
// dispatchä¸ºè‡ªåŠ¨æ¥æ”¶çš„store.dispatchå‡½æ•°
export const getHttpAction = (url, func) => (dispatch) => {
  axios.get(url).then(function (res) {
    const action = func(res.data);
    dispatch(action);
  });
};
```

- ç”Ÿæˆ actionï¼Œå¹¶å‘é€ action

```jsx
componentDidMount(){
    var action = getHttpAction('/getData', getInitTodoItemAction)
    // å‘é€å‡½æ•°ç±»å‹çš„actionæ—¶ï¼Œè¯¥actionçš„å‡½æ•°ä½“ä¼šè‡ªåŠ¨æ‰§è¡Œ
    store.dispatch(action)
}
```

#### **ä½¿ç”¨ redux-saga ä¸­é—´ä»¶**

**redux-saga**ä¼˜ç‚¹:

- å¼‚æ­¥è§£è€¦: å¼‚æ­¥æ“ä½œè¢«è¢«è½¬ç§»åˆ°å•ç‹¬ saga.js ä¸­ï¼Œä¸å†æ˜¯æºæ‚åœ¨ action.js æˆ– component.js ä¸­
- action æ‘†è„± thunk function: dispatch çš„å‚æ•°ä¾ç„¶æ˜¯â¼€ä¸ªçº¯ç²¹çš„ action (FSA)ï¼Œâ½½ä¸æ˜¯å……æ»¡ â€œâ¿Šé­”æ³•â€ thunk function
- å¼‚å¸¸å¤„ç†: å—ç›Šäº generator function çš„ saga å®ç°ï¼Œä»£ç å¼‚å¸¸/è¯·æ±‚å¤±è´¥ éƒ½å¯ä»¥ç›´æ¥é€šè¿‡ try/catch è¯­æ³•ç›´æ¥æ•è·å¤„ç†
- åŠŸèƒ½å¼ºâ¼¤: redux-saga æä¾›äº†â¼¤é‡çš„ Saga è¾…åŠ©å‡½æ•°å’Œ Effect åˆ›å»ºå™¨ä¾›å¼€å‘è€…ä½¿â½¤,å¼€å‘è€…â½†é¡»å°è£…æˆ–è€…ç®€å•å°è£…å³å¯ä½¿â½¤
- çµæ´»: redux-saga å¯ä»¥å°†å¤šä¸ª Saga å¯ä»¥ä¸²â¾/å¹¶â¾ç»„åˆèµ·æ¥,å½¢æˆâ¼€ä¸ªâ¾®å¸¸å®â½¤çš„å¼‚æ­¥ flow
- æ˜“æµ‹è¯•ï¼Œæä¾›äº†å„ç§ case çš„æµ‹è¯•â½…æ¡ˆï¼ŒåŒ…æ‹¬ mock taskï¼Œåˆ†â½€è¦†ç›–ç­‰ç­‰

**redux-saga**ç¼ºé™·:

- é¢å¤–çš„å­¦ä¹ æˆæœ¬: redux-saga ä¸ä»…åœ¨ä½¿â½¤éš¾ä»¥ç†è§£çš„ generator function,â½½ä¸”æœ‰æ•°â¼—ä¸ª API,å­¦ä¹ æˆæœ¬è¿œè¶… redux-thunk,æœ€é‡è¦çš„æ˜¯ä½ çš„é¢å¤–å­¦ä¹ æˆæœ¬æ˜¯åªæœåŠ¡äºè¿™ä¸ªåº“çš„,ä¸ redux-observable ä¸åŒ,redux-observable è™½ç„¶ä¹Ÿæœ‰é¢å¤–å­¦ä¹ æˆæœ¬ä½†æ˜¯èƒŒåæ˜¯ rxjs å’Œâ¼€æ•´å¥—æ€æƒ³
- ä½“ç§¯åºâ¼¤: ä½“ç§¯ç•¥â¼¤,ä»£ç è¿‘ 2000 â¾ï¼Œmin ç‰ˆ 25KB å·¦å³
- åŠŸèƒ½è¿‡å‰©: å®é™…ä¸Šå¹¶å‘æ§åˆ¶ç­‰åŠŸèƒ½å¾ˆéš¾â½¤åˆ°,ä½†æ˜¯æˆ‘ä»¬ä¾ç„¶éœ€è¦å¼•â¼Šè¿™äº›ä»£ç 
- ts â½€æŒä¸å‹å¥½: yield â½†æ³•è¿”å› TS ç±»å‹

redux-saga å¯ä»¥æ•è· actionï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠå¼‚æ­¥ä»£ç æ”¾åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š

- é…ç½®ä¸­é—´ä»¶

```jsx
import { createStore, applyMiddleware, compose } from "redux";
import reducer from "./reducer";
import createSagaMiddleware from "redux-saga";
import TodoListSaga from "./sagas";

const composeEnhancers = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__
  ? window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({})
  : compose;
const sagaMiddleware = createSagaMiddleware();

const enhancer = composeEnhancers(applyMiddleware(sagaMiddleware));

const store = createStore(reducer, enhancer);
sagaMiddleware.run(TodoListSaga);

export default store;
```

- å°†å¼‚æ­¥è¯·æ±‚æ”¾åœ¨ sagas.js ä¸­

```jsx
import { takeEvery, put } from "redux-saga/effects";
import { initTodoList } from "./actionCreator";
import { GET_INIT_ITEM } from "./actionTypes";
import axios from "axios";

function* func() {
  try {
    // å¯ä»¥è·å–å¼‚æ­¥è¿”å›æ•°æ®
    const res = yield axios.get("/getData");
    const action = initTodoList(res.data);
    // å°†actionå‘é€åˆ°reducer
    yield put(action);
  } catch (e) {
    console.log("ç½‘ç»œè¯·æ±‚å¤±è´¥");
  }
}

function* mySaga() {
  // è‡ªåŠ¨æ•è·GET_INIT_ITEMç±»å‹çš„actionï¼Œå¹¶æ‰§è¡Œfunc
  yield takeEvery(GET_INIT_ITEM, func);
}

export default mySaga;
```

- å‘é€ action

```jsx
componentDidMount(){
  const action = getInitTodoItemAction()
  store.dispatch(action)
}
```

#### æ€»ç»“

ä½¿ç”¨ redux-thunkï¼Œå½“æˆ‘ä»¬è¿”å›çš„æ˜¯å‡½æ•°æ—¶ï¼Œstore ä¼šå¸®æˆ‘ä»¬è°ƒç”¨è¿™ä¸ªè¿”å›çš„å‡½æ•°ï¼Œå¹¶ä¸”æŠŠ dispatch æš´éœ²å‡ºæ¥ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚**å¯¹äº redux-thunk çš„æ•´ä¸ªæµç¨‹æ¥è¯´ï¼Œå®ƒæ˜¯ç­‰å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åï¼Œæˆ‘ä»¬å†å»è°ƒç”¨ dispatchï¼Œç„¶åå» store å»è°ƒç”¨ reduces**

![image-20220927214653024](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/image-20220927214653024.png)

ä½¿ç”¨äº† redux-sagaï¼Œå½“æˆ‘ä»¬ dispatch çš„ action ç±»å‹ä¸åœ¨ reducer ä¸­æ—¶ï¼Œredux-saga çš„ç›‘å¬å‡½æ•°`takeEvery`å°±ä¼šç›‘å¬åˆ°ï¼Œç­‰å¼‚æ­¥ä»»åŠ¡æœ‰ç»“æœå°±æ‰§è¡Œ`put`æ–¹æ³•ï¼Œç›¸å½“äº`dispatch`ï¼Œå†ä¸€æ¬¡è§¦å‘ dispatchã€‚**å¯¹äº redux-saga çš„æ•´ä¸ªæµç¨‹æ¥è¯´ï¼Œå®ƒæ˜¯ç­‰æ‰§è¡Œå®Œ action å’Œ reducer ä¹‹åï¼Œåˆ¤æ–­ reducer ä¸­æœ‰æ²¡æœ‰è¿™ä¸ª action**

![image-20220927214704531](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/image-20220927214704531.png)

æ€»ç»“æ¥çœ‹ï¼Œ**redux-thunk å’Œ redux-saga å¤„ç†å¼‚æ­¥ä»»åŠ¡çš„æ—¶æœºä¸ä¸€æ ·ã€‚å¯¹äº redux-sagaï¼Œç›¸å¯¹äºåœ¨ redux çš„ action åŸºç¡€ä¸Šï¼Œé‡æ–°å¼€è¾Ÿäº†ä¸€ä¸ª async action çš„åˆ†æ”¯ï¼Œå•ç‹¬å¤„ç†å¼‚æ­¥ä»»åŠ¡**

saga è‡ªå·±åŸºæœ¬ä¸Šå®Œå…¨å¼„äº†ä¸€å¥— asyc çš„äº‹ä»¶ç›‘å¬æœºåˆ¶ï¼Œä»£ç é‡å¤§å¤§å¢åŠ ï¼Œä»æˆ‘è‡ªå·±çš„ä½¿ç”¨ä½“éªŒæ¥çœ‹ redux-thunk æ›´ç®€å•ï¼Œå’Œ redux æœ¬èº«è”ç³»åœ°æ›´ç´§å¯†ã€‚å°¤å…¶æ˜¯æ•´ä¸ªç”Ÿæ€éƒ½å‘å‡½æ•°å¼ç¼–ç¨‹é æ‹¢çš„ä»Šå¤©ï¼Œredux-thunk çš„é«˜é˜¶å‡½æ•°çœ‹ä¸Šå»æ›´åŠ å¥‘åˆè¿™ä¸ªé—­ç¯

### 5.Redux æ€ä¹ˆå®ç°å±æ€§ä¼ é€’ï¼ŒåŸç†æ˜¯ä»€ä¹ˆ

react-redux æ•°æ®ä¼ è¾“ âˆ¶ view-->action-->reducer-->store-->viewã€‚çœ‹ä¸‹ç‚¹å‡»äº‹ä»¶çš„æ•°æ®æ˜¯å¦‚ä½•é€šè¿‡ redux ä¼ åˆ° view ä¸Šï¼š

- view ä¸Šçš„ AddClick äº‹ä»¶é€šè¿‡ mapDispatchToProps æŠŠæ•°æ®ä¼ åˆ° action ---> click:()=>dispatch(ADD)
- action çš„ ADD ä¼ åˆ° reducer ä¸Š
- reducer ä¼ åˆ° store ä¸Š const store = createStore(reducer);
- store å†é€šè¿‡ mapStateToProps æ˜ å°„ç©¿åˆ° view ä¸Š text:State.text

ä»£ç ç¤ºä¾‹ âˆ¶

```jsx
import React from "react";
import ReactDOM from "react-dom";
import { createStore } from "redux";
import { Provider, connect } from "react-redux";
class App extends React.Component {
  render() {
    let { text, click, clickR } = this.props;
    return (
      <div>
        <div>æ•°æ®:å·²æœ‰äºº{text}</div>
        <div onClick={click}>åŠ äºº</div>
        <div onClick={clickR}>å‡äºº</div>
      </div>
    );
  }
}
const initialState = {
  text: 5,
};
const reducer = function (state, action) {
  switch (action.type) {
    case "ADD":
      return { text: state.text + 1 };
    case "REMOVE":
      return { text: state.text - 1 };
    default:
      return initialState;
  }
};

let ADD = {
  type: "ADD",
};
let Remove = {
  type: "REMOVE",
};

const store = createStore(reducer);

let mapStateToProps = function (state) {
  return {
    text: state.text,
  };
};

let mapDispatchToProps = function (dispatch) {
  return {
    click: () => dispatch(ADD),
    clickR: () => dispatch(Remove),
  };
};

const App1 = connect(mapStateToProps, mapDispatchToProps)(App);

ReactDOM.render(
  <Provider store={store}>
    <App1></App1>
  </Provider>,
  document.getElementById("root")
);
```

### 6.Redux ä¸­é—´ä»¶æ˜¯ä»€ä¹ˆï¼Ÿæ¥å—å‡ ä¸ªå‚æ•°ï¼ŸæŸ¯é‡ŒåŒ–å‡½æ•°ä¸¤ç«¯çš„å‚æ•°å…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿ

Redux çš„ä¸­é—´ä»¶æä¾›çš„æ˜¯**ä½äº action è¢«å‘èµ·ä¹‹åï¼Œåˆ°è¾¾ reducer ä¹‹å‰çš„æ‰©å±•ç‚¹**ï¼Œæ¢è€Œè¨€ä¹‹ï¼ŒåŸæœ¬ view -â†’> action -> reducer -> store çš„æ•°æ®æµåŠ ä¸Šä¸­é—´ä»¶åå˜æˆäº† view -> action -> middleware -> reducer -> store ï¼Œåœ¨è¿™ä¸€ç¯èŠ‚å¯ä»¥åšä¸€äº›"å‰¯ä½œç”¨"çš„æ“ä½œï¼Œå¦‚å¼‚æ­¥è¯·æ±‚ã€æ‰“å°æ—¥å¿—ç­‰ã€‚

applyMiddleware æºç ï¼š

```jsx
export default function applyMiddleware(...middlewares) {
  return (createStore) =>
    (...args) => {
      // åˆ©ç”¨ä¼ å…¥çš„createStoreå’Œreducerå’Œåˆ›å»ºä¸€ä¸ªstore
      const store = createStore(...args);
      let dispatch = () => {
        throw new Error();
      };
      const middlewareAPI = {
        getState: store.getState,
        dispatch: (...args) => dispatch(...args),
      };
      // è®©æ¯ä¸ª middleware å¸¦ç€ middlewareAPI è¿™ä¸ªå‚æ•°åˆ†åˆ«æ‰§è¡Œä¸€é
      const chain = middlewares.map((middleware) => middleware(middlewareAPI));
      // æ¥ç€ compose å°† chain ä¸­çš„æ‰€æœ‰åŒ¿åå‡½æ•°ï¼Œç»„è£…æˆä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œå³æ–°çš„ dispatch
      dispatch = compose(...chain)(store.dispatch);
      return {
        ...store,
        dispatch,
      };
    };
}
```

ä» applyMiddleware ä¸­å¯ä»¥çœ‹å‡º âˆ¶

- redux ä¸­é—´ä»¶**æ¥å—ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¯¹è±¡çš„å‚æ•°ä¸Šæœ‰ä¸¤ä¸ªå­—æ®µ dispatch å’Œ getStateï¼Œåˆ†åˆ«ä»£è¡¨ç€ Redux Store ä¸Šçš„ä¸¤ä¸ªåŒåå‡½æ•°**ã€‚
- æŸ¯é‡ŒåŒ–å‡½æ•°ä¸¤ç«¯ä¸€ä¸ªæ˜¯ middewaresï¼Œä¸€ä¸ªæ˜¯ store.dispatch

### 7.Redux è¯·æ±‚ä¸­é—´ä»¶å¦‚ä½•å¤„ç†å¹¶å‘

**ä½¿ç”¨ redux-Saga** redux-saga æ˜¯ä¸€ä¸ªç®¡ç† redux åº”ç”¨å¼‚æ­¥æ“ä½œçš„ä¸­é—´ä»¶ï¼Œç”¨äºä»£æ›¿ redux-thunk çš„ã€‚å®ƒé€šè¿‡åˆ›å»º Sagas å°†æ‰€æœ‰å¼‚æ­¥æ“ä½œé€»è¾‘å­˜æ”¾åœ¨ä¸€ä¸ªåœ°æ–¹è¿›è¡Œé›†ä¸­å¤„ç†ï¼Œä»¥æ­¤å°† react ä¸­çš„åŒæ­¥æ“ä½œä¸å¼‚æ­¥æ“ä½œåŒºåˆ†å¼€æ¥ï¼Œä»¥ä¾¿äºåæœŸçš„ç®¡ç†ä¸ç»´æŠ¤ã€‚ redux-saga å¦‚ä½•å¤„ç†å¹¶å‘ï¼š

- **takeEvery**

å¯ä»¥è®©å¤šä¸ª saga ä»»åŠ¡å¹¶è¡Œè¢« fork æ‰§è¡Œã€‚

```jsx
import { fork, take } from "redux-saga/effects";

const takeEvery = (pattern, saga, ...args) =>
  fork(function* () {
    while (true) {
      const action = yield take(pattern);
      yield fork(saga, ...args.concat(action));
    }
  });
```

- **takeLatest**

takeLatest ä¸å…è®¸å¤šä¸ª saga ä»»åŠ¡å¹¶è¡Œåœ°æ‰§è¡Œã€‚ä¸€æ—¦æ¥æ”¶åˆ°æ–°çš„å‘èµ·çš„ actionï¼Œå®ƒå°±ä¼šå–æ¶ˆå‰é¢æ‰€æœ‰ fork è¿‡çš„ä»»åŠ¡ï¼ˆå¦‚æœè¿™äº›ä»»åŠ¡è¿˜åœ¨æ‰§è¡Œçš„è¯ï¼‰ã€‚ åœ¨å¤„ç† AJAX è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœåªå¸Œæœ›è·å–æœ€åé‚£ä¸ªè¯·æ±‚çš„å“åº”ï¼Œ takeLatest å°±ä¼šéå¸¸æœ‰ç”¨ã€‚

```jsx
import { cancel, fork, take } from "redux-saga/effects";

const takeLatest = (pattern, saga, ...args) =>
  fork(function* () {
    let lastTask;
    while (true) {
      const action = yield take(pattern);
      if (lastTask) {
        yield cancel(lastTask); // å¦‚æœä»»åŠ¡å·²ç»ç»“æŸï¼Œåˆ™ cancel ä¸ºç©ºæ“ä½œ
      }
      lastTask = yield fork(saga, ...args.concat(action));
    }
  });
```

### 8.Redux çŠ¶æ€ç®¡ç†å™¨å’Œå˜é‡æŒ‚è½½åˆ° window ä¸­æœ‰ä»€ä¹ˆåŒºåˆ«

ä¸¤è€…éƒ½æ˜¯å­˜å‚¨æ•°æ®ä»¥ä¾›åæœŸä½¿ç”¨ã€‚ä½†æ˜¯ Redux çŠ¶æ€æ›´æ”¹å¯å›æº¯â€”â€”Time travelï¼Œæ•°æ®å¤šäº†çš„æ—¶å€™å¯ä»¥å¾ˆæ¸…æ™°çš„çŸ¥é“æ”¹åŠ¨åœ¨å“ªé‡Œå‘ç”Ÿï¼Œå®Œæ•´çš„æä¾›äº†ä¸€å¥—çŠ¶æ€ç®¡ç†æ¨¡å¼ã€‚

éšç€ JavaScript å•é¡µåº”ç”¨å¼€å‘æ—¥è¶‹å¤æ‚ï¼ŒJavaScript éœ€è¦ç®¡ç†æ¯”ä»»ä½•æ—¶å€™éƒ½è¦å¤šçš„ state ï¼ˆçŠ¶æ€ï¼‰ã€‚ è¿™äº› state å¯èƒ½åŒ…æ‹¬æœåŠ¡å™¨å“åº”ã€ç¼“å­˜æ•°æ®ã€æœ¬åœ°ç”Ÿæˆå°šæœªæŒä¹…åŒ–åˆ°æœåŠ¡å™¨çš„æ•°æ®ï¼Œä¹ŸåŒ…æ‹¬ UI çŠ¶æ€ï¼Œå¦‚æ¿€æ´»çš„è·¯ç”±ï¼Œè¢«é€‰ä¸­çš„æ ‡ç­¾ï¼Œæ˜¯å¦æ˜¾ç¤ºåŠ è½½åŠ¨æ•ˆæˆ–è€…åˆ†é¡µå™¨ç­‰ç­‰ã€‚

ç®¡ç†ä¸æ–­å˜åŒ–çš„ state éå¸¸å›°éš¾ã€‚å¦‚æœä¸€ä¸ª model çš„å˜åŒ–ä¼šå¼•èµ·å¦ä¸€ä¸ª model å˜åŒ–ï¼Œé‚£ä¹ˆå½“ view å˜åŒ–æ—¶ï¼Œå°±å¯èƒ½å¼•èµ·å¯¹åº” model ä»¥åŠå¦ä¸€ä¸ª model çš„å˜åŒ–ï¼Œä¾æ¬¡åœ°ï¼Œå¯èƒ½ä¼šå¼•èµ·å¦ä¸€ä¸ª view çš„å˜åŒ–ã€‚ç›´è‡³ä½ æä¸æ¸…æ¥šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚state åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œç”±äºä»€ä¹ˆåŸå› ï¼Œå¦‚ä½•å˜åŒ–å·²ç„¶ä¸å—æ§åˆ¶ã€‚ å½“ç³»ç»Ÿå˜å¾—é”™ç»¼å¤æ‚çš„æ—¶å€™ï¼Œæƒ³é‡ç°é—®é¢˜æˆ–è€…æ·»åŠ æ–°åŠŸèƒ½å°±ä¼šå˜å¾—ä¸¾æ­¥ç»´è‰°ã€‚ å¦‚æœè¿™è¿˜ä¸å¤Ÿç³Ÿç³•ï¼Œè€ƒè™‘ä¸€äº›æ¥è‡ªå‰ç«¯å¼€å‘é¢†åŸŸçš„æ–°éœ€æ±‚ï¼Œå¦‚æ›´æ–°è°ƒä¼˜ã€æœåŠ¡ç«¯æ¸²æŸ“ã€è·¯ç”±è·³è½¬å‰è¯·æ±‚æ•°æ®ç­‰ç­‰ã€‚å‰ç«¯å¼€å‘è€…æ­£åœ¨ç»å—å‰æ‰€æœªæœ‰çš„å¤æ‚æ€§ï¼Œéš¾é“å°±è¿™ä¹ˆæ”¾å¼ƒäº†å—?å½“ç„¶ä¸æ˜¯ã€‚

è¿™é‡Œçš„å¤æ‚æ€§å¾ˆå¤§ç¨‹åº¦ä¸Šæ¥è‡ªäºï¼šæˆ‘ä»¬æ€»æ˜¯å°†ä¸¤ä¸ªéš¾ä»¥ç†æ¸…çš„æ¦‚å¿µæ··æ·†åœ¨ä¸€èµ·ï¼šå˜åŒ–å’Œå¼‚æ­¥ã€‚ å¯ä»¥ç§°å®ƒä»¬ä¸ºæ›¼å¦¥æ€å’Œå¯ä¹ã€‚å¦‚æœæŠŠäºŒè€…åˆ†å¼€ï¼Œèƒ½åšçš„å¾ˆå¥½ï¼Œä½†æ··åˆ°ä¸€èµ·ï¼Œå°±å˜å¾—ä¸€å›¢ç³Ÿã€‚ä¸€äº›åº“å¦‚ React è§†å›¾åœ¨è§†å›¾å±‚ç¦æ­¢å¼‚æ­¥å’Œç›´æ¥æ“ä½œ DOM æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼ŒReact ä¾æ—§æŠŠå¤„ç† state ä¸­æ•°æ®çš„é—®é¢˜ç•™ç»™äº†ä½ ã€‚Redux å°±æ˜¯ä¸ºäº†å¸®ä½ è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

### 9.Redux ä¸­é—´ä»¶æ˜¯æ€ä¹ˆæ‹¿åˆ° store å’Œ action? ç„¶åæ€ä¹ˆå¤„ç†?

1.redux ä¸­é—´ä»¶æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°æŸ¯é‡ŒåŒ–ã€‚redux applyMiddleware Api æºç ä¸­æ¯ä¸ª middleware æ¥å— 2 ä¸ªå‚æ•°ï¼Œ Store çš„**getState å‡½æ•°å’Œ dispatch å‡½æ•°ï¼Œ**åˆ†åˆ«è·å¾—**store å’Œ actionï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªå‡½æ•°**ã€‚

2.è¯¥å‡½æ•°ä¼šè¢«ä¼ å…¥ next çš„**ä¸‹ä¸€ä¸ª middleware çš„ dispatch æ–¹æ³•**ï¼Œå¹¶**è¿”å›ä¸€ä¸ªæ¥æ”¶ action çš„æ–°å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥ç›´æ¥è°ƒç”¨ nextï¼ˆactionï¼‰**ï¼Œæˆ–è€…åœ¨å…¶ä»–éœ€è¦çš„æ—¶åˆ»è°ƒç”¨ï¼Œç”šè‡³æ ¹æœ¬ä¸å»è°ƒç”¨å®ƒã€‚

3.è°ƒç”¨é“¾ä¸­æœ€åä¸€ä¸ª middleware ä¼šæ¥å—**çœŸå®çš„ store çš„ dispatch æ–¹æ³•**ä½œä¸º next å‚æ•°ï¼Œå¹¶å€Ÿæ­¤ç»“æŸè°ƒç”¨é“¾ã€‚æ‰€ä»¥ï¼Œmiddleware çš„å‡½æ•°ç­¾åæ˜¯ï¼ˆ{ getStateï¼Œdispatch })=> next => actionã€‚

### 10.Redux ä¸­çš„ connect æœ‰ä»€ä¹ˆä½œç”¨

connect è´Ÿè´£è¿æ¥ React å’Œ Redux

**ï¼ˆ1ï¼‰è·å– state**

connect é€šè¿‡ context è·å– Provider ä¸­çš„ storeï¼Œé€šè¿‡ `store.getState()` è·å–æ•´ä¸ª store tree ä¸Šæ‰€æœ‰ state

**ï¼ˆ2ï¼‰åŒ…è£…åŸç»„ä»¶**

å°† state å’Œ action é€šè¿‡ props çš„æ–¹å¼ä¼ å…¥åˆ°åŸç»„ä»¶å†…éƒ¨ wrapWithConnect è¿”å›â€”ä¸ª ReactComponent å¯¹ è±¡ Connectï¼ŒConnect é‡ æ–° render å¤–éƒ¨ä¼ å…¥çš„åŸç»„ä»¶ WrappedComponent ï¼Œå¹¶æŠŠ connect ä¸­ä¼ å…¥çš„ mapStateToPropsï¼ŒmapDispatchToProps ä¸ç»„ä»¶ä¸ŠåŸæœ‰çš„ props åˆå¹¶åï¼Œé€šè¿‡å±æ€§çš„æ–¹å¼ä¼ ç»™ WrappedComponent

**ï¼ˆ3ï¼‰ç›‘å¬ store tree å˜åŒ–**

connect ç¼“å­˜äº† store tree ä¸­ state çš„çŠ¶æ€ï¼Œé€šè¿‡å½“å‰ state çŠ¶æ€ å’Œå˜æ›´å‰ state çŠ¶æ€è¿›è¡Œæ¯”è¾ƒï¼Œä»è€Œç¡®å®šæ˜¯å¦è°ƒç”¨ `this.setState()`æ–¹æ³•è§¦å‘ Connect åŠå…¶å­ç»„ä»¶çš„é‡æ–°æ¸²æŸ“

### 11.Redux å’Œ Vuex æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå®ƒä»¬çš„å…±åŒæ€æƒ³

**ï¼ˆ1ï¼‰Redux å’Œ Vuex åŒºåˆ«**

- Vuex æ”¹è¿›äº† Redux ä¸­çš„ Action å’Œ Reducer å‡½æ•°ï¼Œä»¥ mutations å˜åŒ–å‡½æ•°å–ä»£ Reducerï¼Œæ— éœ€ switchï¼Œåªéœ€åœ¨å¯¹åº”çš„ mutation å‡½æ•°é‡Œæ”¹å˜ state å€¼å³å¯
- Vuex ç”±äº Vue è‡ªåŠ¨é‡æ–°æ¸²æŸ“çš„ç‰¹æ€§ï¼Œæ— éœ€è®¢é˜…é‡æ–°æ¸²æŸ“å‡½æ•°ï¼Œåªè¦ç”Ÿæˆæ–°çš„ State å³å¯
- Vuex æ•°æ®æµçš„é¡ºåºæ˜¯ âˆ¶View è°ƒç”¨ store.commit æäº¤å¯¹åº”çš„è¯·æ±‚åˆ° Store ä¸­å¯¹åº”çš„ mutation å‡½æ•°->store æ”¹å˜ï¼ˆvue æ£€æµ‹åˆ°æ•°æ®å˜åŒ–è‡ªåŠ¨æ¸²æŸ“ï¼‰

é€šä¿—ç‚¹ç†è§£å°±æ˜¯ï¼Œvuex å¼±åŒ– dispatchï¼Œé€šè¿‡ commit è¿›è¡Œ store çŠ¶æ€çš„ä¸€æ¬¡æ›´å˜ï¼›å–æ¶ˆäº† action æ¦‚å¿µï¼Œä¸å¿…ä¼ å…¥ç‰¹å®šçš„ action å½¢å¼è¿›è¡ŒæŒ‡å®šå˜æ›´ï¼›å¼±åŒ– reducerï¼ŒåŸºäº commit å‚æ•°ç›´æ¥å¯¹æ•°æ®è¿›è¡Œè½¬å˜ï¼Œä½¿å¾—æ¡†æ¶æ›´åŠ ç®€æ˜“;

**ï¼ˆ2ï¼‰å…±åŒæ€æƒ³**

- å•â€”çš„æ•°æ®æº
- å˜åŒ–å¯ä»¥é¢„æµ‹

æœ¬è´¨ä¸Š âˆ¶ redux ä¸ vuex éƒ½æ˜¯å¯¹ mvvm æ€æƒ³çš„æœåŠ¡ï¼Œå°†æ•°æ®ä»è§†å›¾ä¸­æŠ½ç¦»çš„ä¸€ç§æ–¹æ¡ˆã€‚

### 12.mobx çš„ä½¿ç”¨

#### å“åº”å¼å¯¹è±¡

MobX é€šè¿‡ `makeObservable` æ–¹æ³•æ¥æ„é€ å“åº”å¼å¯¹è±¡ï¼Œä¼ å…¥çš„å¯¹è±¡å±æ€§ä¼šé€šè¿‡ `Proxy` ä»£ç†ï¼Œä¸ Vue ç±»ä¼¼ï¼Œåœ¨ 6.0 ç‰ˆæœ¬ä¹‹å‰ä½¿ç”¨çš„æ˜¯ `Object.defineProperty` APIï¼Œå½“ç„¶ 6.0 ä¹Ÿæä¾›äº†é™çº§æ–¹æ¡ˆã€‚

```js
import { configure, makeObservable, observable, action, computed } from "mobx";

// ä½¿ç”¨è¯¥é…ç½®ï¼Œå¯ä»¥å°† Proxy é™çº§ä¸º Object.defineProperty
configure({ useProxies: "never" });

// æ„é€ å“åº”å¯¹è±¡
const store = makeObservable(
  // éœ€è¦ä»£ç†çš„å“åº”å¯¹è±¡
  {
    count: 0,
    get double() {
      return this.count * 2;
    },
    increment() {
      this.count += 1;
    },
    decrement() {
      this.count -= 1;
    },
  },
  // å¯¹å„ä¸ªå±æ€§è¿›è¡ŒåŒ…è£…ï¼Œç”¨äºæ ‡è®°è¯¥å±æ€§çš„ä½œç”¨
  {
    count: observable, // éœ€è¦è·Ÿè¸ªçš„å“åº”å±æ€§
    double: computed, // è®¡ç®—å±æ€§
    increment: action, // action è°ƒç”¨åï¼Œä¼šä¿®æ”¹å“åº”å¯¹è±¡
    decrement: action, // action è°ƒç”¨åï¼Œä¼šä¿®æ”¹å“åº”å¯¹è±¡
  }
);
```

æˆ‘ä»¬åœ¨çœ‹çœ‹ä¹‹å‰ç‰ˆæœ¬çš„ MobXï¼Œä½¿ç”¨è£…é¥°å™¨çš„å†™æ³•ï¼š

```js
class Store {
  @observable count = 0;
  constructor() {
    makeObservable(this);
  }
  @action increment() {
    this.count++;
  }
  @action decrement() {
    this.count--;
  }
  @computed get double() {
    return this.count * 2;
  }
}

const store = new Store();
```

è¿™ä¹ˆçœ‹èµ·æ¥ï¼Œå¥½åƒå†™æ³•å¹¶æ²¡æœ‰å¾—åˆ°ä»€ä¹ˆç®€åŒ–ï¼Œå¥½åƒæ¯”å†™è£…é¥°å™¨è¿˜è¦å¤æ‚ç‚¹ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ 6.0 ç‰ˆæœ¬ä¸€ä¸ªæ›´å¼ºå¤§çš„ APIï¼š`makeAutoObservable`ã€‚

`makeAutoObservable` æ˜¯ä¸€ä¸ªæ›´å¼ºå¤§çš„ `makeObservable`ï¼Œå¯ä»¥è‡ªåŠ¨ä¸ºå±æ€§åŠ ä¸Šå¯¹è±¡çš„åŒ…è£…å‡½æ•°ï¼Œä¸Šæ‰‹æˆæœ¬ç›´çº¿ä¸‹é™ã€‚

```js
import { makeAutoObservable } from "mobx";

const store = makeAutoObservable({
  count: 0,
  get double() {
    return this.count * 2;
  },
  increment() {
    this.count += 1;
  },
  decrement() {
    this.count -= 1;
  },
});
```

#### è®¡ç®—å±æ€§

MobX çš„å±æ€§ä¸ Vue çš„ `computed` ä¸€æ ·ï¼Œåœ¨ `makeAutoObservable` ä¸­å°±æ˜¯ä¸€ä¸ª `getter`ï¼Œ`getter` ä¾èµ–çš„å€¼ä¸€æ—¦å‘ç”Ÿå˜åŒ–ï¼Œ`getter` æœ¬èº«çš„è¿”å›å€¼ä¹Ÿä¼šè·Ÿéšå˜åŒ–ã€‚

```js
import { makeAutoObservable } from "mobx";

const store = makeAutoObservable({
  count: 0,
  get double() {
    return this.count * 2;
  },
});
```

å½“ `store.count` ä¸º 1 æ—¶ï¼Œè°ƒç”¨ `store.double` ä¼šè¿”å› 2ã€‚

#### ä¿®æ”¹è¡Œä¸º

å½“æˆ‘ä»¬éœ€è¦ä¿®æ”¹ store ä¸Šçš„å“åº”å±æ€§æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥é‡æ–°èµ‹å€¼çš„æ–¹å¼ä¿®æ”¹ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¾—åˆ° MobX çš„è­¦å‘Š âš ï¸ã€‚

```js
const store = makeAutoObservable({
  count: 0,
});

document.getElementById("increment").onclick = function () {
  store.count += 1;
};
```

![warn](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb4328c95ca9477b8df74bfa5d484bd9~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

MobX ä¼šæç¤ºï¼Œåœ¨ä¿®æ”¹å“åº”å¼å¯¹è±¡çš„å±æ€§æ—¶ï¼Œéœ€è¦é€šè¿‡ action çš„æ–¹å¼ä¿®æ”¹ã€‚è™½ç„¶ç›´æ¥ä¿®æ”¹ä¹Ÿèƒ½ç”Ÿæ•ˆï¼Œä½†æ˜¯è¿™æ ·ä¼šè®© MobX çŠ¶æ€çš„ç®¡ç†æ¯”è¾ƒæ··ä¹±ï¼Œè€Œä¸”å°†çŠ¶æ€ä¿®æ”¹æ”¾åˆ° action ä¸­ï¼Œèƒ½å¤Ÿè®© MobX åœ¨å†…éƒ¨çš„äº‹åŠ¡æµç¨‹ä¸­è¿›è¡Œä¿®æ”¹ï¼Œä»¥å…æ‹¿åˆ°çš„æŸä¸ªå±æ€§è¿˜å¤„äºä¸­é—´æ€ï¼Œæœ€åè®¡ç®—çš„ç»“æœä¸å¤Ÿå‡†ç¡®ã€‚

`makeAutoObservable` ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¢«å¤„ç†æˆ **action**ã€‚

```js
import { makeAutoObservable } from "mobx";

const store = makeAutoObservable({
  count: 0,
  get double() {
    return this.count * 2;
  },
  increment() {
    // action
    this.count += 1;
  },
  decrement() {
    // action
    this.count -= 1;
  },
});
```

ä¸åŒäº Vuexï¼Œå°†çŠ¶æ€çš„ä¿®æ”¹åˆ’åˆ†ä¸º mutation å’Œ actionï¼ŒåŒæ­¥ä¿®æ”¹æ”¾åˆ° mutation ä¸­ï¼Œå¼‚æ­¥çš„æ“ä½œæ”¾åˆ° action ä¸­ã€‚åœ¨ MobX ä¸­ï¼Œä¸ç®¡æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ“ä½œï¼Œéƒ½å¯ä»¥æ”¾åˆ° action ä¸­ï¼Œåªæ˜¯å¼‚æ­¥æ“ä½œåœ¨ä¿®æ”¹å±æ€§æ—¶ï¼Œéœ€è¦å°†èµ‹å€¼æ“ä½œæ”¾åˆ° `runInAction` ä¸­ã€‚

```js
import { runInAction, makeAutoObservable } from "mobx";

const store = makeAutoObservable({
  count: 0,
  async initCount() {
    // æ¨¡æ‹Ÿè·å–è¿œç¨‹çš„æ•°æ®
    const count = await new Promise((resolve) => {
      setTimeout(() => {
        resolve(10);
      }, 500);
    });
    // è·å–æ•°æ®åï¼Œå°†èµ‹å€¼æ“ä½œæ”¾åˆ° runInAction ä¸­
    runInAction(() => {
      this.count = count;
    });
  },
});

store.initCount();
```

å¦‚æœä¸è°ƒç”¨ `runInAction` ï¼Œåˆ™å¯ä»¥ç›´æ¥è°ƒç”¨æœ¬èº«å·²ç»å­˜åœ¨çš„ actionã€‚

```js
import { runInAction, makeAutoObservable } from "mobx";

const store = makeAutoObservable({
  count: 0,
  setCount(count) {
    this.count = count;
  },
  async initCount() {
    // æ¨¡æ‹Ÿè·å–è¿œç¨‹çš„æ•°æ®
    const count = await new Promise((resolve) => {
      setTimeout(() => {
        resolve(10);
      }, 500);
    });
    // è·å–æ•°æ®åï¼Œè°ƒç”¨å·²æœ‰çš„ action
    this.setCount(count);
  },
});

store.initCount();
```

#### ç›‘å¬å¯¹è±¡å˜æ›´

æ— è®ºæ˜¯åœ¨ React è¿˜æ˜¯åœ¨å°ç¨‹åºä¸­æƒ³è¦å¼•å…¥ MobXï¼Œéƒ½éœ€è¦åœ¨å¯¹è±¡å˜æ›´çš„æ—¶å€™ï¼Œé€šçŸ¥è°ƒç”¨åŸç”Ÿçš„ `setState/setData` æ–¹æ³•ï¼Œå°†çŠ¶æ€åŒæ­¥åˆ°è§†å›¾ä¸Šã€‚

é€šè¿‡ `autorun` æ–¹æ³•å¯ä»¥å®ç°è¿™ä¸ªèƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ `autorun` ç†è§£ä¸º React Hooks ä¸­çš„ `useEffect`ã€‚æ¯å½“ store çš„å“åº”å±æ€§å‘ç”Ÿä¿®æ”¹æ—¶ï¼Œä¼ å…¥ `autorun` çš„æ–¹æ³•ï¼ˆ`effect`ï¼‰å°±ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚

```js
import { autorun, makeAutoObservable } from "mobx";

const store = makeAutoObservable({
  count: 0,
  setCount(count) {
    this.count = count;
  },
  increment() {
    this.count++;
  },
  decrement() {
    this.count--;
  },
});

document.getElementById("increment").onclick = function () {
  store.count++;
};

const $count = document.getElementById("count");
$count.innerText = `${store.count}`;
autorun(() => {
  $count.innerText = `${store.count}`;
});
```

æ¯å½“ `button#increment` æŒ‰é’®è¢«ç‚¹å‡»çš„æ—¶å€™ï¼Œ`span#count` å†…çš„å€¼å°±ä¼šè‡ªåŠ¨è¿›è¡ŒåŒæ­¥ã€‚ğŸ‘‰[æŸ¥çœ‹å®Œæ•´ä»£ç ](https://link.juejin.cn?target=https%3A%2F%2Fcodesandbox.io%2Fembed%2Fmobx6-d9bex)ã€‚

![æ•ˆæœæ¼”ç¤º](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/prm9iBeoZyjOEHh.webp)

é™¤äº† `autorun` ï¼ŒMobX è¿˜æä¾›äº†æ›´ç²¾ç»†åŒ–çš„ç›‘å¬æ–¹æ³•ï¼š`reaction`ã€ `when`ã€‚

```js
const store = makeAutoObservable({
  count: 0,
  setCount(count) {
    this.count = count;
  },
  increment() {
    this.count++;
  },
  decrement() {
    this.count--;
  },
});

// store å‘ç”Ÿä¿®æ”¹ç«‹å³è°ƒç”¨ effect
autorun(() => {
  $count.innerText = `${store.count}`;
});

// ç¬¬ä¸€ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¿®æ”¹åæ‰ä¼šè°ƒç”¨åé¢çš„ effect
reaction(
  // è¡¨ç¤º store.count ä¿®æ”¹åæ‰ä¼šè°ƒç”¨
  () => store.count,
  // ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå½“å‰å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºä¿®æ”¹å‰çš„å€¼
  // æœ‰ç‚¹ç±»ä¼¼ä¸ Vue ä¸­çš„ watch
  (value, prevValue) => {
    console.log("diff", value - prevValue);
  }
);

// ç¬¬ä¸€ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä¸ºçœŸï¼Œç«‹å³è°ƒç”¨åé¢çš„ effect
when(
  () => store.count > 10,
  () => {
    console.log(store.count);
  }
)(
  // when æ–¹æ³•è¿˜èƒ½è¿”å›ä¸€ä¸ª promise
  async function () {
    await when(() => store.count > 10);
    console.log("store.count > 10");
  }
)();
```

#### mobox å’Œ redux æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**ï¼ˆ1ï¼‰å…±åŒç‚¹**

- ä¸ºäº†è§£å†³çŠ¶æ€ç®¡ç†æ··ä¹±ï¼Œæ— æ³•æœ‰æ•ˆåŒæ­¥çš„é—®é¢˜ç»Ÿä¸€ç»´æŠ¤ç®¡ç†åº”ç”¨çŠ¶æ€;
- æŸä¸€çŠ¶æ€åªæœ‰ä¸€ä¸ªå¯ä¿¡æ•°æ®æ¥æºï¼ˆé€šå¸¸å‘½åä¸º storeï¼ŒæŒ‡çŠ¶æ€å®¹å™¨ï¼‰;
- æ“ä½œæ›´æ–°çŠ¶æ€æ–¹å¼ç»Ÿä¸€ï¼Œå¹¶ä¸”å¯æ§ï¼ˆé€šå¸¸ä»¥ action æ–¹å¼æä¾›æ›´æ–°çŠ¶æ€çš„é€”å¾„ï¼‰;
- æ”¯æŒå°† store ä¸ React ç»„ä»¶è¿æ¥ï¼Œå¦‚ react-reduxï¼Œmobx- react;

**ï¼ˆ2ï¼‰åŒºåˆ«** Redux æ›´å¤šçš„æ˜¯éµå¾ª Flux æ¨¡å¼çš„ä¸€ç§å®ç°ï¼Œæ˜¯ä¸€ä¸ª JavaScript åº“ï¼Œå®ƒå…³æ³¨ç‚¹ä¸»è¦æ˜¯ä»¥ä¸‹å‡ æ–¹é¢ âˆ¶

- Actionâˆ¶ ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œæè¿°åŠ¨ä½œç›¸å…³ä¿¡æ¯ï¼Œä¸»è¦åŒ…å« type å±æ€§å’Œ payload å±æ€§ âˆ¶

  ```jsx
  o typeâˆ¶ action ç±»å‹; o payloadâˆ¶ è´Ÿè½½æ•°æ®;
  ```

- Reducerâˆ¶ å®šä¹‰åº”ç”¨çŠ¶æ€å¦‚ä½•å“åº”ä¸åŒåŠ¨ä½œï¼ˆactionï¼‰ï¼Œå¦‚ä½•æ›´æ–°çŠ¶æ€;

- Storeâˆ¶ ç®¡ç† action å’Œ reducer åŠå…¶å…³ç³»çš„å¯¹è±¡ï¼Œä¸»è¦æä¾›ä»¥ä¸‹åŠŸèƒ½ âˆ¶

  ```jsx
  o ç»´æŠ¤åº”ç”¨çŠ¶æ€å¹¶æ”¯æŒè®¿é—®çŠ¶æ€(getState());
  o æ”¯æŒç›‘å¬actionçš„åˆ†å‘ï¼Œæ›´æ–°çŠ¶æ€(dispatch(action));
  o æ”¯æŒè®¢é˜…storeçš„å˜æ›´(subscribe(listener));
  ```

- å¼‚æ­¥æµ âˆ¶ ç”±äº Redux æ‰€æœ‰å¯¹ store çŠ¶æ€çš„å˜æ›´ï¼Œéƒ½åº”è¯¥é€šè¿‡ action è§¦å‘ï¼Œå¼‚æ­¥ä»»åŠ¡ï¼ˆé€šå¸¸éƒ½æ˜¯ä¸šåŠ¡æˆ–è·å–æ•°æ®ä»»åŠ¡ï¼‰ä¹Ÿä¸ä¾‹å¤–ï¼Œè€Œä¸ºäº†ä¸å°†ä¸šåŠ¡æˆ–æ•°æ®ç›¸å…³çš„ä»»åŠ¡æ··å…¥ React ç»„ä»¶ä¸­ï¼Œå°±éœ€è¦ä½¿ç”¨å…¶ä»–æ¡†æ¶é…åˆç®¡ç†å¼‚æ­¥ä»»åŠ¡æµç¨‹ï¼Œå¦‚ redux-thunkï¼Œredux-saga ç­‰;

Mobx æ˜¯ä¸€ä¸ªé€æ˜å‡½æ•°å“åº”å¼ç¼–ç¨‹çš„çŠ¶æ€ç®¡ç†åº“ï¼Œå®ƒä½¿å¾—çŠ¶æ€ç®¡ç†ç®€å•å¯ä¼¸ âˆ¶

- Actionâˆ¶ å®šä¹‰æ”¹å˜çŠ¶æ€çš„åŠ¨ä½œå‡½æ•°ï¼ŒåŒ…æ‹¬å¦‚ä½•å˜æ›´çŠ¶æ€;
- Storeâˆ¶ é›†ä¸­ç®¡ç†æ¨¡å—çŠ¶æ€ï¼ˆStateï¼‰å’ŒåŠ¨ä½œ(action)
- Derivationï¼ˆè¡ç”Ÿï¼‰âˆ¶ ä»åº”ç”¨çŠ¶æ€ä¸­æ´¾ç”Ÿè€Œå‡ºï¼Œä¸”æ²¡æœ‰ä»»ä½•å…¶ä»–å½±å“çš„æ•°æ®

**å¯¹æ¯”æ€»ç»“ï¼š**

- redux å°†æ•°æ®ä¿å­˜åœ¨å•ä¸€çš„ store ä¸­ï¼Œmobx å°†æ•°æ®ä¿å­˜åœ¨åˆ†æ•£çš„å¤šä¸ª store ä¸­
- redux ä½¿ç”¨ plain object ä¿å­˜æ•°æ®ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†å˜åŒ–åçš„æ“ä½œ;mobx é€‚ç”¨ observable ä¿å­˜æ•°æ®ï¼Œæ•°æ®å˜åŒ–åè‡ªåŠ¨å¤„ç†å“åº”çš„æ“ä½œ
- redux ä½¿ç”¨ä¸å¯å˜çŠ¶æ€ï¼Œè¿™æ„å‘³ç€çŠ¶æ€æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ç›´æ¥å»ä¿®æ”¹å®ƒï¼Œè€Œæ˜¯åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„çŠ¶æ€ï¼ŒåŒæ—¶ä½¿ç”¨çº¯å‡½æ•°;mobx ä¸­çš„çŠ¶æ€æ˜¯å¯å˜çš„ï¼Œå¯ä»¥ç›´æ¥å¯¹å…¶è¿›è¡Œä¿®æ”¹
- mobx ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œåœ¨å…¶ä¸­æœ‰å¾ˆå¤šçš„æŠ½è±¡ï¼Œmobx æ›´å¤šçš„ä½¿ç”¨é¢å‘å¯¹è±¡çš„ç¼–ç¨‹æ€ç»´;redux ä¼šæ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºå…¶ä¸­çš„å‡½æ•°å¼ç¼–ç¨‹æ€æƒ³æŒæ¡èµ·æ¥ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ï¼ŒåŒæ—¶éœ€è¦å€ŸåŠ©ä¸€ç³»åˆ—çš„ä¸­é—´ä»¶æ¥å¤„ç†å¼‚æ­¥å’Œå‰¯ä½œç”¨
- mobx ä¸­æœ‰æ›´å¤šçš„æŠ½è±¡å’Œå°è£…ï¼Œè°ƒè¯•ä¼šæ¯”è¾ƒå›°éš¾ï¼ŒåŒæ—¶ç»“æœä¹Ÿéš¾ä»¥é¢„æµ‹;è€Œ redux æä¾›èƒ½å¤Ÿè¿›è¡Œæ—¶é—´å›æº¯çš„å¼€å‘å·¥å…·ï¼ŒåŒæ—¶å…¶çº¯å‡½æ•°ä»¥åŠæ›´å°‘çš„æŠ½è±¡ï¼Œè®©è°ƒè¯•å˜å¾—æ›´åŠ çš„å®¹æ˜“

### 13.dva çš„ä½¿ç”¨

[ä¸€æ–‡å½»åº•ææ‡‚ DvaJS åŸç†](https://juejin.cn/post/6963466553601835044)

#### Dva æ˜¯ä»€ä¹ˆ

dva é¦–å…ˆæ˜¯ä¸€ä¸ªåŸºäº[redux](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freduxjs%2Fredux)å’Œ[redux-saga](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fredux-saga%2Fredux-saga)çš„æ•°æ®æµæ–¹æ¡ˆï¼Œç„¶åä¸ºäº†ç®€åŒ–å¼€å‘ä½“éªŒï¼Œdva è¿˜é¢å¤–å†…ç½®äº†[react-router](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FReactTraining%2Freact-router)å’Œ[fetch](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Ffetch)ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè½»é‡çº§çš„åº”ç”¨æ¡†æ¶ã€‚

#### Dva è§£å†³çš„é—®é¢˜

> ç»è¿‡ä¸€æ®µæ—¶é—´çš„è‡ªå­¦æˆ–åŸ¹è®­ï¼Œå¤§å®¶åº”è¯¥éƒ½èƒ½ç†è§£ redux çš„æ¦‚å¿µï¼Œå¹¶è®¤å¯è¿™ç§æ•°æ®æµçš„æ§åˆ¶å¯ä»¥è®©åº”ç”¨æ›´å¯æ§ï¼Œä»¥åŠè®©é€»è¾‘æ›´æ¸…æ™°ã€‚ä½†éšä¹‹è€Œæ¥é€šå¸¸ä¼šæœ‰è¿™æ ·çš„ç–‘é—®ï¼šæ¦‚å¿µå¤ªå¤šï¼Œå¹¶ä¸” reducer, saga, action éƒ½æ˜¯åˆ†ç¦»çš„ï¼ˆåˆ†æ–‡ä»¶ï¼‰ã€‚

- æ–‡ä»¶åˆ‡æ¢é—®é¢˜ã€‚redux çš„é¡¹ç›®é€šå¸¸è¦åˆ† reducer, action, saga, component ç­‰ç­‰ï¼Œä»–ä»¬çš„åˆ†ç›®å½•å­˜æ”¾é€ æˆçš„æ–‡ä»¶åˆ‡æ¢æˆæœ¬è¾ƒå¤§ã€‚
- ä¸ä¾¿äºç»„ç»‡ä¸šåŠ¡æ¨¡å‹ (æˆ–è€…å« domain model) ã€‚æ¯”å¦‚æˆ‘ä»¬å†™äº†ä¸€ä¸ª userlist ä¹‹åï¼Œè¦å†™ä¸€ä¸ª productlistï¼Œéœ€è¦å¤åˆ¶å¾ˆå¤šæ–‡ä»¶ã€‚
- saga åˆ›å»ºéº»çƒ¦ï¼Œæ¯ç›‘å¬ä¸€ä¸ª action éƒ½éœ€è¦èµ° fork -> watcher -> worker çš„æµç¨‹
- entry åˆ›å»ºéº»çƒ¦ã€‚å¯ä»¥çœ‹ä¸‹è¿™ä¸ª[redux entry](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fantd-init%2Fblob%2Fmaster%2Fboilerplates%2Fredux%2Fsrc%2Fentries%2Findex.js)çš„ä¾‹å­ï¼Œé™¤äº† redux store çš„åˆ›å»ºï¼Œä¸­é—´ä»¶çš„é…ç½®ï¼Œè·¯ç”±çš„åˆå§‹åŒ–ï¼ŒProvider çš„ store çš„ç»‘å®šï¼Œsaga çš„åˆå§‹åŒ–ï¼Œè¿˜è¦å¤„ç† reducer, component, saga çš„ HMR ã€‚è¿™å°±æ˜¯çœŸå®çš„é¡¹ç›®åº”ç”¨ redux çš„ä¾‹å­ï¼Œçœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ã€‚

#### Dva çš„ä¼˜åŠ¿

- **æ˜“å­¦æ˜“ç”¨**ï¼Œä»…æœ‰ 6 ä¸ª apiï¼Œå¯¹ redux ç”¨æˆ·å°¤å…¶å‹å¥½ï¼Œ[é…åˆ umi ä½¿ç”¨](https://link.juejin.cn?target=https%3A%2F%2Fumijs.org%2Fguide%2Fwith-dva.html)åæ›´æ˜¯é™ä½ä¸º 0 API
- **elm æ¦‚å¿µ**ï¼Œé€šè¿‡ reducers, effects å’Œ subscriptions ç»„ç»‡ model
- **æ’ä»¶æœºåˆ¶**ï¼Œæ¯”å¦‚[dva-loading](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdvajs%2Fdva%2Ftree%2Fmaster%2Fpackages%2Fdva-loading)å¯ä»¥è‡ªåŠ¨å¤„ç† loading çŠ¶æ€ï¼Œä¸ç”¨ä¸€ééåœ°å†™ showLoading å’Œ hideLoading
- **æ”¯æŒ HMR**ï¼ŒåŸºäº[babel-plugin-dva-hmr](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdvajs%2Fbabel-plugin-dva-hmr)å®ç° componentsã€routes å’Œ models çš„ HMR

#### Dva çš„åŠ£åŠ¿

- **æœªæ¥ä¸ç¡®å®šæ€§é«˜ã€‚**[dva@3 å‰å¹´æå‡ºè®¡åˆ’åï¼Œå®˜æ–¹å‡ ä¹ä¸å†ç»´æŠ¤](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdvajs%2Fdva%2Fissues%2F2208)ã€‚

- å¯¹äºç»å¤§å¤šæ•°ä¸æ˜¯ç‰¹åˆ«å¤æ‚çš„åœºæ™¯æ¥è¯´ï¼Œ**ç›®å‰å¯ä»¥è¢« Hooks å–ä»£**

#### Dva çš„é€‚ç”¨åœºæ™¯

- ä¸šåŠ¡åœºæ™¯ï¼šç»„ä»¶é—´é€šä¿¡å¤šï¼Œä¸šåŠ¡å¤æ‚ï¼Œéœ€è¦å¼•å…¥çŠ¶æ€ç®¡ç†çš„é¡¹ç›®
- æŠ€æœ¯åœºæ™¯ï¼šä½¿ç”¨ React Class Component å†™çš„é¡¹ç›®

#### Dva æ ¸å¿ƒæ¦‚å¿µ

- **åŸºäº Redux ç†å¿µçš„æ•°æ®æµå‘**ã€‚ ç”¨æˆ·çš„äº¤äº’æˆ–æµè§ˆå™¨è¡Œä¸ºé€šè¿‡ dispatch å‘èµ·ä¸€ä¸ª actionï¼Œå¦‚æœæ˜¯åŒæ­¥è¡Œä¸ºä¼šç›´æ¥é€šè¿‡ Reducers æ”¹å˜ Stateï¼Œå¦‚æœæ˜¯å¼‚æ­¥è¡Œä¸ºï¼ˆå¯ä»¥ç§°ä¸ºå‰¯ä½œç”¨ï¼‰ä¼šå…ˆè§¦å‘ Effects ç„¶åæµå‘ Reducers æœ€ç»ˆæ”¹å˜ Stateã€‚

![img](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/ErdIJVQkACnvy1W.webp)

- **åŸºäº Redux çš„åŸºæœ¬æ¦‚å¿µ**ã€‚åŒ…æ‹¬ï¼š
  - State æ•°æ®ï¼Œé€šå¸¸ä¸ºä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œæ“ä½œçš„æ—¶å€™æ¯æ¬¡éƒ½è¦å½“ä½œä¸å¯å˜æ•°æ®ï¼ˆimmutable dataï¼‰æ¥å¯¹å¾…ï¼Œä¿è¯æ¯æ¬¡éƒ½æ˜¯å…¨æ–°å¯¹è±¡ï¼Œæ²¡æœ‰å¼•ç”¨å…³ç³»ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ State çš„ç‹¬ç«‹æ€§ï¼Œä¾¿äºæµ‹è¯•å’Œè¿½è¸ªå˜åŒ–ã€‚
  - Action è¡Œä¸ºï¼Œä¸€ä¸ªæ™®é€š JavaScript å¯¹è±¡ï¼Œå®ƒæ˜¯æ”¹å˜ State çš„å”¯ä¸€é€”å¾„ã€‚
  - dispatchï¼Œä¸€ä¸ªç”¨äºè§¦å‘ action æ”¹å˜ State çš„å‡½æ•°ã€‚
  - Reducer æè¿°å¦‚ä½•æ”¹å˜æ•°æ®çš„çº¯å‡½æ•°ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šå·²æœ‰ç»“æœå’Œ action ä¼ å…¥çš„æ•°æ®ï¼Œé€šè¿‡è¿ç®—å¾—åˆ°æ–°çš„ stateã€‚
  - Effectsï¼ˆSide Effectsï¼‰ å‰¯ä½œç”¨ï¼Œå¸¸è§çš„è¡¨ç°ä¸ºå¼‚æ­¥æ“ä½œã€‚dva ä¸ºäº†æ§åˆ¶å‰¯ä½œç”¨çš„æ“ä½œï¼Œåº•å±‚å¼•å…¥äº†[redux-sagas](https://link.juejin.cn?target=http%3A%2F%2Fsuperraytin.github.io%2Fredux-saga-in-chinese)åšå¼‚æ­¥æµç¨‹æ§åˆ¶ï¼Œç”±äºé‡‡ç”¨äº†[generator çš„ç›¸å…³æ¦‚å¿µ](https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2015%2F04%2Fgenerator.html)ï¼Œæ‰€ä»¥å°†å¼‚æ­¥è½¬æˆåŒæ­¥å†™æ³•ï¼Œä»è€Œå°† effects è½¬ä¸ºçº¯å‡½æ•°ã€‚
  - Connect ä¸€ä¸ªå‡½æ•°ï¼Œç»‘å®š State åˆ° View
- **å…¶ä»–æ¦‚å¿µ**
  - Subscriptionï¼Œè®¢é˜…ï¼Œä»**æºå¤´**è·å–æ•°æ®ï¼Œç„¶åæ ¹æ®æ¡ä»¶ dispatch éœ€è¦çš„ actionï¼Œæ¦‚å¿µæ¥æºäº[elm](https://link.juejin.cn?target=https%3A%2F%2Felm-lang.org%2Fnews%2Ffarewell-to-frp)ã€‚æ•°æ®æºå¯ä»¥æ˜¯å½“å‰çš„æ—¶é—´ã€æœåŠ¡å™¨çš„ websocket è¿æ¥ã€keyboard è¾“å…¥ã€geolocation å˜åŒ–ã€history è·¯ç”±å˜åŒ–ç­‰ç­‰ã€‚
  - Routerï¼Œå‰ç«¯è·¯ç”±ï¼Œdva å®ä¾‹æä¾›äº† router æ–¹æ³•æ¥æ§åˆ¶è·¯ç”±ï¼Œä½¿ç”¨çš„æ˜¯[react-router](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freactjs%2Freact-router)ã€‚
  - Route Componentsï¼Œè·Ÿæ•°æ®é€»è¾‘æ— å…³çš„ç»„ä»¶ã€‚é€šå¸¸éœ€è¦ connect Model çš„ç»„ä»¶éƒ½æ˜¯ Route Componentsï¼Œç»„ç»‡åœ¨/routes/ç›®å½•ä¸‹ï¼Œè€Œ/components/ç›®å½•ä¸‹åˆ™æ˜¯çº¯ç»„ä»¶ï¼ˆPresentational Componentsï¼Œè¯¦è§[ç»„ä»¶è®¾è®¡æ–¹æ³•](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdvajs%2Fdva-docs%2Fblob%2Fmaster%2Fv1%2Fzh-cn%2Ftutorial%2F04-%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95.md)ï¼‰

#### Dva åº”ç”¨æœ€ç®€ç»“æ„

##### ä¸å¸¦ Model

```js
import dva from "dva";
const App = () => <div>Hello dva</div>;
// åˆ›å»ºåº”ç”¨
const app = dva();
// æ³¨å†Œè§†å›¾
app.router(() => <App />);
// å¯åŠ¨åº”ç”¨
app.start("#root");
```

##### å¸¦ Model

```js
// åˆ›å»ºåº”ç”¨
const app = dva();
app.use(createLoading()); // ä½¿ç”¨æ’ä»¶
// æ³¨å†Œ Model
app.model({
  namespace: "count",
  state: 0,
  reducers: {
    add(state) {
      return state + 1;
    },
  },
  effects: {
    *addAfter1Second(action, { call, put }) {
      yield call(delay, 1000);
      yield put({ type: "add" });
    },
  },
});
// æ³¨å†Œè§†å›¾
app.router(() => <ConnectedApp />);
// å¯åŠ¨åº”ç”¨
app.start("#root");
```

#### Dva åº•å±‚åŸç†å’Œéƒ¨åˆ†å…³é”®å®ç°

##### èƒŒæ™¯ä»‹ç»

1. æ•´ä¸ª dva é¡¹ç›®ä½¿ç”¨ lerna ç®¡ç†çš„ï¼Œåœ¨æ¯ä¸ª package çš„ package.json ä¸­æ‰¾åˆ°æ¨¡å—å¯¹åº”çš„å…¥å£æ–‡ä»¶ï¼Œç„¶åæŸ¥çœ‹å¯¹åº”æºç ã€‚
2. dva æ˜¯ä¸ªå‡½æ•°ï¼Œè¿”å›ä¸€äº†ä¸ª app çš„å¯¹è±¡ã€‚
3. ç›®å‰ dva çš„æºç æ ¸å¿ƒéƒ¨åˆ†åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œdva å’Œ dva-coreã€‚å‰è€…ç”¨é«˜é˜¶ç»„ä»¶ React-redux å®ç°äº† view å±‚ï¼Œåè€…æ˜¯ç”¨ redux-saga è§£å†³äº† model å±‚ã€‚

##### [dva](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdvajs%2Fdva%2Fblob%2Fmaster%2Fpackages%2Fdva%2Fsrc%2Findex.js)

dva åšäº†ä¸‰ä»¶æ¯”è¾ƒé‡è¦çš„äº‹æƒ…ï¼š

1. ä»£ç† router å’Œ start æ–¹æ³•ï¼Œå®ä¾‹åŒ– app å¯¹è±¡
2. è°ƒç”¨ dva-core çš„ start æ–¹æ³•ï¼ŒåŒæ—¶æ¸²æŸ“è§†å›¾
3. ä½¿ç”¨ react-redux å®Œæˆäº† react åˆ° redux çš„è¿æ¥ã€‚

```js
// dva/src/index.js
export default function (opts = {}) {
  // 1. ä½¿ç”¨ connect-react-router å’Œ history åˆå§‹åŒ– router å’Œ history
  // é€šè¿‡æ·»åŠ  redux çš„ä¸­é—´ä»¶ react-redux-routerï¼Œå¼ºåŒ–äº† history å¯¹è±¡çš„åŠŸèƒ½
  const history = opts.history || createHashHistory();
  const createOpts = {
    initialReducer: {
      router: connectRouter(history),
    },
    setupMiddlewares(middlewares) {
      return [routerMiddleware(history), ...middlewares];
    },
    setupApp(app) {
      app._history = patchHistory(history);
    },
  };
  // 2. è°ƒç”¨ dva-core é‡Œçš„ create æ–¹æ³• ï¼Œå‡½æ•°å†…å®ä¾‹åŒ–ä¸€ä¸ª app å¯¹è±¡ã€‚
  const app = create(opts, createOpts);
  const oldAppStart = app.start;
  // 3. ç”¨è‡ªå®šä¹‰çš„ router å’Œ start æ–¹æ³•ä»£ç†
  app.router = router;
  app.start = start;
  return app;
  // 3.1 ç»‘å®šç”¨æˆ·ä¼ é€’çš„ router åˆ° app._router
  function router(router) {
    invariant(
      isFunction(router),
      `[app.router] router should be function, but got ${typeof router}`
    );
    app._router = router;
  }
  // 3.2 è°ƒç”¨ dva-core çš„ start æ–¹æ³•ï¼Œå¹¶æ¸²æŸ“è§†å›¾
  function start(container) {
    // å¯¹ container åšä¸€ç³»åˆ—æ£€æŸ¥ï¼Œå¹¶æ ¹æ® container æ‰¾åˆ°å¯¹åº”çš„DOMèŠ‚ç‚¹
    if (!app._store) {
      oldAppStart.call(app);
    }
    const store = app._store;
    // ä¸ºHMRæš´éœ²_getProvideræ¥å£
    // ref: https://github.com/dvajs/dva/issues/469
    app._getProvider = getProvider.bind(null, store, app);
    // æ¸²æŸ“è§†å›¾
    if (container) {
      render(container, store, app, app._router);
      app._plugin.apply("onHmr")(render.bind(null, container, store, app));
    } else {
      return getProvider(store, this, this._router);
    }
  }
}
function getProvider(store, app, router) {
  const DvaRoot = (extraProps) => (
    <Provider store={store}>
      {router({ app, history: app._history, ...extraProps })}
    </Provider>
  );
  return DvaRoot;
}
function render(container, store, app, router) {
  const ReactDOM = require("react-dom"); // eslint-disable-line
  ReactDOM.render(
    React.createElement(getProvider(store, app, router)),
    container
  );
}
```

æˆ‘ä»¬åŒæ—¶å¯ä»¥å‘ç° app æ˜¯é€šè¿‡ create(opts, createOpts)è¿›è¡Œåˆå§‹åŒ–çš„ï¼Œå…¶ä¸­ opts æ˜¯æš´éœ²ç»™ä½¿ç”¨è€…çš„é…ç½®ï¼ŒcreateOpts æ˜¯æš´éœ²ç»™å¼€å‘è€…çš„é…ç½®ï¼ŒçœŸå®çš„ create æ–¹æ³•åœ¨ dva-core ä¸­å®ç°

##### [dva-core](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdvajs%2Fdva%2Fblob%2Fmaster%2Fpackages%2Fdva-core%2Fsrc%2Findex.js)

dva-core åˆ™å®Œæˆäº†æ ¸å¿ƒåŠŸèƒ½ï¼š

1. é€šè¿‡ create æ–¹æ³•å®Œæˆ app å®ä¾‹çš„æ„é€ ï¼Œå¹¶æš´éœ² useã€model å’Œ start ä¸‰ä¸ªæ¥å£
2. é€šè¿‡ start æ–¹æ³•å®Œæˆ

- store çš„åˆå§‹åŒ–
- models å’Œ effects çš„å°è£…ï¼Œæ”¶é›†å¹¶è¿è¡Œ sagas
- è¿è¡Œæ‰€æœ‰çš„ model.subscriptions
- æš´éœ² app.modelã€app.unmodelã€app.replaceModel ä¸‰ä¸ªæ¥å£

dva-core create

**ä½œç”¨ï¼š** å®Œæˆ app å®ä¾‹çš„æ„é€ ï¼Œå¹¶æš´éœ² useã€model å’Œ start ä¸‰ä¸ªæ¥å£

```js
// dva-core/src/index.js
const dvaModel = {
  namespace: "@@dva",
  state: 0,
  reducers: {
    UPDATE(state) {
      return state + 1;
    },
  },
};
export function create(hooksAndOpts = {}, createOpts = {}) {
  const { initialReducer, setupApp = noop } = createOpts; // åœ¨dva/index.jsä¸­æ„é€ äº†createOptså¯¹è±¡
  const plugin = new Plugin(); // dva-coreä¸­çš„æ’ä»¶æœºåˆ¶ï¼Œæ¯ä¸ªå®ä¾‹åŒ–çš„dvaå¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªpluginå¯¹è±¡
  plugin.use(filterHooks(hooksAndOpts)); // å°†dva(opts)æ„é€ å‚æ•°optsä¸Šä¸hooksç›¸å…³çš„å±æ€§è½¬æ¢æˆä¸€ä¸ªæ’ä»¶
  const app = {
    _models: [prefixNamespace({ ...dvaModel })],
    _store: null,
    _plugin: plugin,
    use: plugin.use.bind(plugin), // æš´éœ²çš„useæ–¹æ³•ï¼Œæ–¹ä¾¿ç¼–å†™è‡ªå®šä¹‰æ’ä»¶
    model, // æš´éœ²çš„modelæ–¹æ³•ï¼Œç”¨äºæ³¨å†Œmodel
    start, // åŸæœ¬çš„startæ–¹æ³•ï¼Œåœ¨åº”ç”¨æ¸²æŸ“åˆ°DOMèŠ‚ç‚¹æ—¶é€šè¿‡oldStartè°ƒç”¨
  };
  return app;
}
```

dva-core start

**ä½œç”¨ï¼š**

1. å°è£… models å’Œ effects ï¼Œæ”¶é›†å¹¶è¿è¡Œ sagas
2. å®Œæˆ store çš„åˆå§‹åŒ–
3. è¿è¡Œæ‰€æœ‰çš„ model.subscriptions
4. æš´éœ² app.modelã€app.unmodelã€app.replaceModel ä¸‰ä¸ªæ¥å£

```js
function start() {
  const sagaMiddleware = createSagaMiddleware();
  const promiseMiddleware = createPromiseMiddleware(app);
  app._getSaga = getSaga.bind(null);
  const sagas = [];
  const reducers = { ...initialReducer };
  for (const m of app._models) {
    // æŠŠæ¯ä¸ª model åˆå¹¶ä¸ºä¸€ä¸ªreducerï¼Œkey æ˜¯ namespace çš„å€¼ï¼Œvalue æ˜¯ reducer å‡½æ•°
    reducers[m.namespace] = getReducer(m.reducers, m.state, plugin._handleActions);
    if (m.effects) {
      // æ”¶é›†æ¯ä¸ª effects åˆ° sagas æ•°ç»„
      sagas.push(app._getSaga(m.effects, m, onError, plugin.get('onEffect'), hooksAndOpts));
    }
  }
  // åˆå§‹åŒ– Store
  app._store = createStore({
    reducers: createReducer(),
    initialState: hooksAndOpts.initialState || {},
    plugin,
    createOpts,
    sagaMiddleware,
    promiseMiddleware,
  });
  const store = app._store;
  // Extend store
  store.runSaga = sagaMiddleware.run;
  store.asyncReducers = {};
  // Execute listeners when state is changed
  const listeners = plugin.get('onStateChange');
  for (const listener of listeners) {
    store.subscribe(() => {
      listener(store.getState());
    });
  }
  // Run sagas, è°ƒç”¨ Redux-Saga çš„ createSagaMiddleware åˆ›å»º sagaä¸­é—´ä»¶ï¼Œè°ƒç”¨ä¸­é—´ä»¶çš„ run æ–¹æ³•æ‰€æœ‰æ”¶é›†èµ·æ¥çš„å¼‚æ­¥æ–¹æ³•
  // runæ–¹æ³•ç›‘å¬æ¯ä¸€ä¸ªå‰¯ä½œç”¨actionï¼Œå½“actionå‘ç”Ÿçš„æ—¶å€™ï¼Œæ‰§è¡Œå¯¹åº”çš„ saga
  sagas.forEach(sagaMiddleware.run);
  // Setup app
  setupApp(app);
  // è¿è¡Œ subscriptions
  const unlisteners = {};
  for (const model of this._models) {
    if (model.subscriptions) {
      unlisteners[model.namespace] = runSubscription(model.subscriptions, model, app, onError);
    }
  }
  // æš´éœ²ä¸‰ä¸ª Model ç›¸å…³çš„æ¥å£ï¼ŒSetup app.model and app.unmodel
  app.model = injectModel.bind(app, createReducer, onError, unlisteners);
  app.unmodel = unmodel.bind(app, createReducer, reducers, unlisteners);
  app.replaceModel = replaceModel.bind(app, createReducer, reducers, unlisteners, onError);
  /**
   * Create global reducer for redux.
   *
   * @returns {Object}
   */
  function createReducer() {
    return reducerEnhancer(
      combineReducers({
        ...reducers,
        ...extraReducers,
        ...(app._store ? app._store.asyncReducers : {}),
      }),
    );
  }
}
}
```

#### è·¯ç”±

åœ¨å‰é¢çš„ dva.start æ–¹æ³•ä¸­æˆ‘ä»¬çœ‹åˆ°äº† createOptsï¼Œå¹¶äº†è§£åˆ°åœ¨ dva-core çš„ start ä¸­çš„ä¸åŒæ—¶æœºè°ƒç”¨äº†å¯¹åº”æ–¹æ³•ã€‚

```js
import * as routerRedux from "connected-react-router";
const { connectRouter, routerMiddleware } = routerRedux;
const createOpts = {
  initialReducer: {
    router: connectRouter(history),
  },
  setupMiddlewares(middlewares) {
    return [routerMiddleware(history), ...middlewares];
  },
  setupApp(app) {
    app._history = patchHistory(history);
  },
};
```

å…¶ä¸­ initialReducer å’Œ setupMiddlewares åœ¨åˆå§‹åŒ– store æ—¶è°ƒç”¨ï¼Œç„¶åæ‰è°ƒç”¨ setupApp

å¯ä»¥çœ‹è§é’ˆå¯¹ router ç›¸å…³çš„ reducer å’Œä¸­é—´ä»¶é…ç½®ï¼Œå…¶ä¸­ connectRouter å’Œ routerMiddleware å‡ä½¿ç”¨äº† connected-react-router è¿™ä¸ªåº“ï¼Œå…¶ä¸»è¦æ€è·¯æ˜¯ï¼šæŠŠè·¯ç”±è·³è½¬ä¹Ÿå½“åšäº†ä¸€ç§ç‰¹æ®Šçš„ actionã€‚

#### Dva ä¸ Reactã€React-Reduxã€Redux-Saga ä¹‹é—´çš„å·®å¼‚

##### åŸç”Ÿ React

![img](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/ezZa3oU6L421trs.webp)æŒ‰ç…§ React å®˜æ–¹æŒ‡å¯¼æ„è§, å¦‚æœå¤šä¸ª Component ä¹‹é—´è¦å‘ç”Ÿäº¤äº’, é‚£ä¹ˆçŠ¶æ€(å³: æ•°æ®)å°±ç»´æŠ¤åœ¨è¿™äº› Component çš„æœ€å°å…¬çº¦çˆ¶èŠ‚ç‚¹ä¸Š, ä¹Ÿå³æ˜¯

ä»¥åŠ æœ¬èº«ä¸ç»´æŒä»»ä½• state, å®Œå…¨ç”±çˆ¶èŠ‚ç‚¹ ä¼ å…¥ props ä»¥å†³å®šå…¶å±•ç°, æ˜¯ä¸€ä¸ªçº¯å‡½æ•°çš„å­˜åœ¨å½¢å¼, å³: Pure Component

##### React-Redux

![img](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/Upg4QKf31idrXJ5.webp)ä¸ä¸Šå›¾ç›¸æ¯”, å‡ ä¸ªæ˜æ˜¾çš„æ”¹è¿›ç‚¹:

1. çŠ¶æ€åŠé¡µé¢é€»è¾‘ä» é‡Œé¢æŠ½å–å‡ºæ¥, æˆä¸ºç‹¬ç«‹çš„ store, é¡µé¢é€»è¾‘å°±æ˜¯ reducer
2. åŠéƒ½æ˜¯ Pure Component, é€šè¿‡ connect æ–¹æ³•å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç»™å®ƒä¿©åŠ ä¸€å±‚ wrapper ä»è€Œå»ºç«‹èµ·ä¸ store çš„è”ç³»: å¯ä»¥é€šè¿‡ dispatch å‘ store æ³¨å…¥ action, ä¿ƒä½¿ store çš„çŠ¶æ€è¿›è¡Œå˜åŒ–, åŒæ—¶åˆè®¢é˜…äº† store çš„çŠ¶æ€å˜åŒ–, ä¸€æ—¦çŠ¶æ€å˜åŒ–, è¢« connect çš„ç»„ä»¶ä¹Ÿéšä¹‹åˆ·æ–°
3. ä½¿ç”¨ dispatch å¾€ store å‘é€ action çš„è¿™ä¸ªè¿‡ç¨‹æ˜¯å¯ä»¥è¢«æ‹¦æˆªçš„, è‡ªç„¶è€Œç„¶åœ°å°±å¯ä»¥åœ¨è¿™é‡Œå¢åŠ å„ç§ Middleware, å®ç°å„ç§è‡ªå®šä¹‰åŠŸèƒ½, eg: logging

è¿™æ ·ä¸€æ¥, å„ä¸ªéƒ¨åˆ†å„å¸å…¶èŒ, è€¦åˆåº¦æ›´ä½, å¤ç”¨åº¦æ›´é«˜, æ‰©å±•æ€§æ›´å¥½ã€‚

##### Redux-Saga

![img](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/GusO4Wo8RqNdltk.webp)å› ä¸ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Middleware æ‹¦æˆª action, è¿™æ ·ä¸€æ¥å¼‚æ­¥çš„ç½‘ç»œæ“ä½œä¹Ÿå°±å¾ˆæ–¹ä¾¿äº†, åšæˆä¸€ä¸ª Middleware å°±è¡Œäº†, è¿™é‡Œä½¿ç”¨ redux-saga è¿™ä¸ªç±»åº“, ä¸¾ä¸ªæ —å­:

1. ç‚¹å‡»åˆ›å»º Todo çš„æŒ‰é’®, å‘èµ·ä¸€ä¸ª type == addTodo çš„ action
2. saga æ‹¦æˆªè¿™ä¸ª action, å‘èµ· http è¯·æ±‚, å¦‚æœè¯·æ±‚æˆåŠŸ, åˆ™ç»§ç»­å‘ reducer å‘ä¸€ä¸ª type == addTodoSucc çš„ action, æç¤ºåˆ›å»ºæˆåŠŸ, åä¹‹åˆ™å‘é€ type == addTodoFail çš„ action å³å¯

##### Dva

![img](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/GCQ7J8qT5cjBRlz.webp)æœ‰äº†å‰é¢ä¸‰æ­¥çš„é“ºå«, Dva çš„å‡ºç°ä¹Ÿå°±æ°´åˆ°æ¸ æˆäº†, æ­£å¦‚ Dva å®˜ç½‘æ‰€è¨€, Dva æ˜¯åŸºäº React + Redux + Saga çš„æœ€ä½³å®è·µ, å¯¹äºæå‡ç¼–ç ä½“éªŒæœ‰ä¸‰ç‚¹è´¡çŒ®ï¼š

1. æŠŠ store åŠ saga ç»Ÿä¸€ä¸ºä¸€ä¸ª model çš„æ¦‚å¿µ, å†™åœ¨ä¸€ä¸ª js æ–‡ä»¶é‡Œé¢
2. å¢åŠ äº†ä¸€ä¸ª Subscriptions, ç”¨äºæ”¶é›†å…¶ä»–æ¥æºçš„ action, æ¯”å¦‚é”®ç›˜æ“ä½œç­‰
3. model å†™æ³•å¾ˆç®€çº¦, ç±»ä¼¼äº DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰ï¼Œå¯ä»¥æå‡ç¼–ç¨‹çš„æ²‰æµ¸æ„Ÿï¼Œè¿›è€Œæå‡æ•ˆç‡

**çº¦å®šå¤§äºé…ç½®**

```js
app.model({
  namespace: "count",
  state: {
    record: 0,
    current: 0,
  },
  reducers: {
    add(state) {
      const newCurrent = state.current + 1;
      return {
        ...state,
        record: newCurrent > state.record ? newCurrent : state.record,
        current: newCurrent,
      };
    },
    minus(state) {
      return { ...state, current: state.current - 1 };
    },
  },
  effects: {
    *add(action, { call, put }) {
      yield call(delay, 1000);
      yield put({ type: "minus" });
    },
  },
  subscriptions: {
    keyboardWatcher({ dispatch }) {
      key("âŒ˜+up, ctrl+up", () => {
        dispatch({ type: "add" });
      });
    },
  },
});
```

### 14.redux-thunk åˆ†æ

> redux-thunk`å¯ä»¥åˆ©ç”¨`redux`ä¸­é—´ä»¶è®©`redux`æ”¯æŒå¼‚æ­¥çš„`action

```js
// å¦‚æœ action æ˜¯ä¸ªå‡½æ•°ï¼Œå°±è°ƒç”¨è¿™ä¸ªå‡½æ•°
// å¦‚æœ action ä¸æ˜¯å‡½æ•°ï¼Œå°±ä¼ ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
// å‘ç° action æ˜¯å‡½æ•°å°±è°ƒç”¨
const thunk =
  ({ dispatch, getState }) =>
  (next) =>
  (action) => {
    if (typeof action === "function") {
      return action(dispatch, getState);
    }

    return next(action);
  };
export default thunk;
```

#### ç®€å•ä½¿ç”¨

ä¸ç”¨ redux-thunk ä¹‹å‰

```js
// store.js
import { createStore } from "redux";

export const reducer = (
  state = {
    count: 0,
  },
  action
) => {
  switch (action.type) {
    case "CHANGE_DATA": {
      return {
        ...state,
        count: action.data,
      };
    }
    default:
      return state;
  }
};
export const store = createStore(reducer);
// App.jsx
class ReduxTest extends React.Component {
  constructor(props) {
    super(props);
    store.subscribe(() => {
      console.log("subscribe");
      this.setState({
        count: store.getState().count,
      });
    });
  }
  changeData = () => {
    const { count } = store.getState();
    const action = {
      type: "CHANGE_DATA",
      data: count + 1,
    };
    store.dispatch(action);
  };
  render() {
    return (
      <div>
        <span>{this.state?.count}</span>
        <button onClick={this.changeData}>æŒ‰é’®+1</button>
      </div>
    );
  }
}
export default ReduxTest;
```

å¯¹äºä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬ dispatch ä¸€ä¸ª actionï¼Œå…¶ä¸­ action å¿…é¡»ä¸ºä¸€ä¸ªå¯¹è±¡ã€‚

ä½†æ˜¯å®é™…å¼€å‘ä¸­ï¼Œaction é‡Œçš„æ•°æ®å¾€å¾€æ˜¯ä¸€ä¸ªå¼‚æ­¥æ¥å£è·å–çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥

```js
class ReduxTest extends React.Component {
  constructor(props) {
    super(props);
    store.subscribe(() => {
      console.log("subscribe", store.getState());
      this.setState({
        count: store.getState().count,
      });
    });
  }
  changeData = () => {
    const { count } = store.getState();
    let res;
    const p = new Promise((resolve) => {
      setTimeout(() => {
        res = 111;
        resolve(res);
      }, 1000);
    });
    p.then((r) => {
      const action = {
        type: "CHANGE_DATA",
        data: r,
      };
      store.dispatch(action);
    });
  };
  render() {
    return (
      <div>
        <span>{this.state?.count}</span>
        <button onClick={this.changeData}>æŒ‰é’®+1</button>
      </div>
    );
  }
}
export default ReduxTest;
```

ä½†æ˜¯ï¼Œä¸Šè¿°ä¼šæŠŠå¤„ç†çš„å¼‚æ­¥çš„é€»è¾‘å†™åœ¨ç»„ä»¶é‡Œï¼Œä½¿ä»£ç å˜å¾—æ··ä¹±ï¼Œ
å› æ­¤ï¼Œå‡å¦‚æˆ‘ dispatch ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œå»å¤„ç†å¼‚æ­¥çš„é€»è¾‘ï¼Œå²‚ä¸æ˜¯ä½¿ä»£ç å˜å¾—æ›´ç®€æ´ï¼Ÿï¼

```js
const getData = () => {
  let res;
  const p = new Promise((resolve) => {
    setTimeout(() => {
      res = 111;
      resolve(res);
    }, 1000);
  });
  p.then((r) => {
    const action = {
      type: "CHANGE_DATA",
      data: r,
    };
    store.dispatch(action);
  });
};
class ReduxTest extends React.Component {
  constructor(props) {
    super(props);
    store.subscribe(() => {
      console.log("subscribe", store.getState());
      this.setState({
        count: store.getState().count,
      });
    });
  }
  changeData = () => {
    const { count } = store.getState();
    store.dispatch(getData);
  };
  render() {
    return (
      <div>
        <span>{this.state?.count}</span>
        <button onClick={this.changeData}>æŒ‰é’®+1</button>
      </div>
    );
  }
}
export default ReduxTest;
```

è¿™æ ·ï¼Œå°±å°†ç»„ä»¶å’Œå¼‚æ­¥å¤„ç†é€»è¾‘è¿›è¡Œäº†è§£è€¦ã€‚

å…¶å®æ²¡æœ‰ redux-thunkï¼Œä¹Ÿå¯ä»¥å®ŒæˆåŒæ ·çš„åŠŸèƒ½ï¼Œåªæ˜¯å°†å¤„ç†å¼‚æ­¥é€»è¾‘çš„ä»£ç å†™åœ¨ç»„ä»¶é‡Œï¼Œä¸ºäº†è®©ä»£ç æ›´ç®€æ´ã€è§£è€¦ï¼Œæ‰€ä»¥é€šè¿‡ redux-thunk å¯ä»¥ dispatch ä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨è¿™ä¸ªå‡½æ•°é‡Œå¤„ç†å¼‚æ­¥æ“ä½œã€‚

#### æºç åˆ†æ

åœ¨ä½¿ç”¨ Redux è¿‡ç¨‹ï¼Œé€šè¿‡ dispatch æ–¹æ³•æ´¾å‘ä¸€ä¸ª action å¯¹è±¡ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ redux-thunk åï¼Œå¯ä»¥ dispatch ä¸€ä¸ª functionã€‚redux-thunk ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ª functionï¼Œå¹¶ä¸”ä¼ é€’ dispatch, getState æ–¹æ³•ä½œä¸ºå‚æ•°ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨è¿™ä¸ª function é‡Œé¢å¤„ç†å¼‚æ­¥é€»è¾‘ï¼Œå¤„ç†å¤æ‚é€»è¾‘ï¼Œè¿™æ˜¯åŸæ¥ Redux åšä¸åˆ°çš„ï¼Œå› ä¸ºåŸæ¥å°±åªèƒ½ dispatch ä¸€ä¸ªç®€å•å¯¹è±¡

redux-thunk çš„æºç æ¯”è¾ƒç®€æ´ï¼Œå®é™…å°± 11 è¡Œã€‚å‰å‡ ç¯‡æˆ‘ä»¬è¯´åˆ° redux çš„ä¸­é—´ä»¶å½¢å¼ï¼Œ
æœ¬è´¨ä¸Šæ˜¯å¯¹ store.dispatch æ–¹æ³•è¿›è¡Œäº†å¢å¼ºæ”¹é€ ï¼ŒåŸºæœ¬æ˜¯ç±»ä¼¼è¿™ç§å½¢å¼ï¼š

```js
const middleware = (store) => (next) => (action) => {};
```

å…ˆç»™ä¸ªç¼©æ°´ç‰ˆçš„å®ç°ï¼š

```javascript
const thunk =
  ({ getState, dispatch }) =>
  (next) =>
  (action) => {
    if (typeof action === "function") {
      return action(dispatch, getState);
    }
    return next(action);
  };
export default thunk;
```

- åŸç†ï¼šå³å½“ action ä¸º function çš„æ—¶å€™ï¼Œå°±è°ƒç”¨è¿™ä¸ª function (ä¼ å…¥ dispatch, getState)å¹¶è¿”å›ï¼›å¦‚æœä¸æ˜¯ï¼Œå°±ç›´æ¥ä¼ ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚

å®Œæ•´æºç å¦‚ä¸‹ï¼š

```javascript
function createThunkMiddleware(extraArgument) {
  return ({ dispatch, getState }) =>
    (next) =>
    (action) => {
      // å¦‚æœactionæ˜¯ä¸€ä¸ªfunctionï¼Œå°±è¿”å›action(dispatch, getState, extraArgument)ï¼Œå¦åˆ™è¿”å›next(action)ã€‚
      if (typeof action === "function") {
        return action(dispatch, getState, extraArgument);
      }
      // nextä¸ºä¹‹å‰ä¼ å…¥çš„store.dispatchï¼Œå³æ”¹å†™å‰çš„dispatch
      return next(action);
    };
}

const thunk = createThunkMiddleware();
// ç»™thunkè®¾ç½®ä¸€ä¸ªå˜é‡withExtraArgumentï¼Œå¹¶ä¸”å°†createThunkMiddlewareæ•´ä¸ªå‡½æ•°èµ‹ç»™å®ƒ
thunk.withExtraArgument = createThunkMiddleware;

export default thunk;
```

æˆ‘ä»¬å‘ç°å…¶å®è¿˜å¤šäº† extraArgument ä¼ å…¥ï¼Œè¿™ä¸ªæ˜¯è‡ªå®šä¹‰å‚æ•°ï¼Œå¦‚ä¸‹ç”¨æ³•ï¼š

```javascript
const api = "https://jsonplaceholder.typicode.com/todos/1";
const whatever = 10;

const store = createStore(
  reducer,
  applyMiddleware(thunk.withExtraArgument({ api, whatever }))
);

// later
function fetchData() {
  return (dispatch, getState, { api, whatever }) => {
    // you can use api and something else here
  };
}
```

### 15.redux-saga åˆ†æ

[æ·±å…¥æµ…å‡º Redux Sagaâ€”â€”åŸç†æµ…æ](https://blog.csdn.net/juse__we/article/details/107598535)

#### Side Effects å‰¯ä½œç”¨

æˆ‘ä»¬ç»å¸¸ä¼šæåˆ°å‰¯ä½œç”¨ï¼Œå°±æ˜¯ä¸ºäº†å¤„ç†å‰¯ä½œç”¨æˆ‘ä»¬æ‰ä¼šä½¿ç”¨ Thunkï¼Œ Saga è¿™äº›å·¥å…·ï¼Œé‚£ä»€ä¹ˆæ˜¯å‰¯ä½œç”¨ï¼Ÿ

##### ä»€ä¹ˆæ˜¯å‰¯ä½œç”¨ï¼Ÿ

> é²è¿…è¯´ï¼šå‰¯ä½œç”¨æ˜¯åœ¨è®¡ç®—ç»“æœçš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»ŸçŠ¶æ€çš„ä¸€ç§å˜åŒ–ï¼Œæˆ–è€…ä¸å¤–éƒ¨ä¸–ç•Œè¿›è¡Œçš„å¯è§‚å¯Ÿçš„äº¤äº’ã€‚

ç®€å•åœ°è¯´ï¼Œ**åªè¦æ˜¯è·Ÿå‡½æ•°å¤–éƒ¨ç¯å¢ƒå‘ç”Ÿçš„äº¤äº’å°±éƒ½å±äºå‰¯ä½œç”¨**ã€‚

æ˜¯ä¸æ˜¯è¿˜æ˜¯æœ‰ç‚¹å›°æƒ‘ï¼Ÿæˆ‘ä»¬ä¸¾äº›ä¾‹å­å§ï¼Œå‰¯ä½œç”¨åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹æƒ…å†µï¼š

- å‘é€ä¸€ä¸ª http è¯·æ±‚
- æ›´æ”¹æ–‡ä»¶ç³»ç»Ÿ
- å¾€æ•°æ®åº“æ’å…¥è®°å½•
- ä½¿ç”¨ LocalStorage è¿›è¡Œæœ¬åœ°å­˜å‚¨
- æ‰“å°/log
- è·å–ç”¨æˆ·è¾“å…¥
- DOM æŸ¥è¯¢
- è®¿é—®ç³»ç»ŸçŠ¶æ€

å¤§æ¦‚çŸ¥é“ä»€ä¹ˆæ˜¯å‰¯ä½œç”¨ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­äº†è§£ä¸¤ä¸ªè¯ï¼š**çº¯å‡½æ•° & éçº¯å‡½æ•°**

##### ä»€ä¹ˆæ˜¯çº¯å‡½æ•°ï¼Ÿ

**çº¯å‡½æ•°ï¼š**

å‡½æ•°ä¸å¤–ç•Œäº¤äº’å”¯ä¸€æ¸ é“å°±æ˜¯â€”â€”**å‚æ•°**å’Œ**è¿”å›å€¼**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š
å‡½æ•°ä»**å‡½æ•°å¤–éƒ¨æ¥å—çš„æ‰€æœ‰è¾“å…¥ä¿¡æ¯**éƒ½é€šè¿‡**å‚æ•°**ä¼ é€’åˆ°è¯¥å‡½æ•°å†…éƒ¨ï¼›å‡½æ•°**è¾“å‡ºåˆ°å‡½æ•°å¤–éƒ¨çš„æ‰€æœ‰ä¿¡æ¯**éƒ½é€šè¿‡**è¿”å›å€¼**ä¼ é€’åˆ°è¯¥å‡½æ•°å¤–éƒ¨ã€‚

##### ä»€ä¹ˆæ˜¯éçº¯å‡½æ•°ï¼Ÿ

éçº¯å‡½æ•°ï¼š

å‡½æ•°é€šè¿‡**å‚æ•°å’Œè¿”å›å€¼ä»¥å¤–**çš„æ¸ é“ï¼Œå’Œå¤–ç•Œè¿›è¡Œæ•°æ®äº¤æ¢ã€‚
æ¯”å¦‚ï¼Œè¯»å–/ä¿®æ”¹å…¨å±€å˜é‡ï¼›æ¯”å¦‚ï¼Œä» local storage è¯»å–æ•°æ®ï¼Œè¿˜å°†å…¶æ‰“å°åˆ°å±å¹•ï¼›å†æ¯”å¦‚åœ¨å‡½æ•°é‡Œå‘èµ·ä¸€ä¸ª http è¯·æ±‚è·å–æ•°æ®ã€‚ã€‚

é‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿½æ±‚çº¯å‡½æ•°ï¼Ÿé‚£å®ƒå½“ç„¶æœ‰å®ƒçš„å¥½å¤„äº†ã€‚

- **å¼•ç”¨é€æ˜æ€§**ï¼šçº¯å‡½æ•°æ€»æ˜¯èƒ½å¤Ÿæ ¹æ®ç›¸åŒçš„è¾“å…¥è¿”å›ç›¸åŒçš„è¾“å‡ºï¼Œæ‰€ä»¥å®ƒä»¬å°±èƒ½å¤Ÿä¿è¯æ€»æ˜¯è¿”å›åŒä¸€ä¸ªç»“æœã€‚
- **å¯ç§»æ¤æ€§ï¼è‡ªæ–‡æ¡£åŒ–**ï¼šçº¯å‡½æ•°å†…éƒ¨ä¸ç¯å¢ƒæ— å…³ï¼Œå¯ä»¥è‡ªç»™è‡ªè¶³ï¼Œæ›´æ˜“äºè§‚å¯Ÿå’Œç†è§£ï¼Œä¸€åˆ‡ä¾èµ–éƒ½ä»å‚æ•°ä¸­ä¼ é€’è¿›æ¥ï¼Œæ‰€ä»¥ä»…ä»å‡½æ•°ç­¾åæˆ‘ä»¬å°±å¾—çŸ¥è¶³å¤Ÿçš„ä¿¡æ¯ã€‚
- **å¯ç¼“å­˜æ€§**ï¼šç”±äºä»¥ä¸Šç‰¹æ€§ï¼Œçº¯å‡½æ•°æ€»èƒ½å¤Ÿæ ¹æ®è¾“å…¥åšç¼“å­˜ï¼Œä¾‹å¦‚ memoize å‡½æ•°ï¼Œç”¨ä¸€ä¸ªå¯¹è±¡æ¥ç¼“å­˜è®¡ç®—ç»“æœã€‚
- **å¯æµ‹è¯•æ€§**ï¼šä¸éœ€è¦ä¼ªé€ ç¯å¢ƒï¼Œåªéœ€ç®€å•åœ°ç»™å‡½æ•°ä¸€ä¸ªè¾“å…¥ï¼Œç„¶åæ–­è¨€è¾“å‡ºå°±å¥½äº†ã€‚

##### è®©äººè®¨åŒçš„å‰¯ä½œç”¨ï¼Ÿ

è¯´äº†è¿™ä¹ˆå¤šçº¯å‡½æ•°çš„å¥½å¤„ï¼Œæˆ‘ä»¬è´¹åŠ²å¿ƒæ€å°†è®©äººè®¨åŒçš„å‰¯ä½œç”¨å¤„ç†æ‰ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å†™æœ‰å‰¯ä½œç”¨çš„ä»£ç å•Šï¼Ÿ

ä½†æ˜¯å›è¿‡å¤´æƒ³æƒ³ï¼Œå‰¯ä½œç”¨éƒ½æ˜¯æˆ‘ä»¬ç¨‹åºé‡Œçš„å…³é”®ï¼Œå‡å¦‚æ²¡æœ‰å‰¯ä½œç”¨ï¼Œä¸€åˆ‡éƒ½å˜å¾—æ¯«æ— æ„ä¹‰äº†ã€‚

å‡å¦‚ä¸€ä¸ªå‰ç«¯é¡¹ç›®ä¸èƒ½å‘èµ· http è¯·æ±‚ä»åç«¯è·å–ä¿¡æ¯ï¼Œ

å‡å¦‚ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæˆ–è€…æ•°æ®åº“ä¸èƒ½è®©æˆ‘ä»¬è¯»å†™æ•°æ®ï¼Œ

å‡å¦‚ä¸èƒ½æ ¹æ®ç”¨æˆ·çš„è¾“å…¥ä»å±å¹•ä¸Šè¾“å‡ºä»–ä»¬æƒ³è¦çš„ä¿¡æ¯

è¿™ä¸€åˆ‡éƒ½æ²¡æœ‰æ„ä¹‰äº†ã€‚

æ‰€ä»¥æˆ‘ä»¬çš„ä»»åŠ¡ä¸æ˜¯æ¶ˆé™¤å‰¯ä½œç”¨ï¼Œè€Œæ˜¯è¦æŠŠå‰¯ä½œç”¨ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…ä¸€äº›ä¸è¯¥å‡ºç°çš„/æˆ‘ä»¬å¹¶ä¸å¸Œæœ›å‡ºç°çš„é—®é¢˜ï¼Œè®©ç¨‹åºçœ‹èµ·æ¥æ›´å¯æ§æ›´çº¯æ´ï½

æ‰€ä»¥æˆ‘ä»¬æ‰ä¼šåœ¨é¡¹ç›®çš„çŠ¶æ€ç®¡ç†ä¸­ä½¿ç”¨ thunkï¼Œsaga ç­‰æ‰‹æ®µå¤„ç†å‰¯ä½œç”¨:)

#### Why Not Redux Thunk

Redux Thunk ä¹Ÿæ˜¯å¤„ç†å‰¯ä½œç”¨çš„ä¸€ä¸ªä¸­é—´ä»¶ï¼Œé‚£ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨ Redux Thunk å‘¢ï¼Ÿ

> é²è¿…è¯´ï¼š å› ä¸ºä¸‘ï¼å®ƒä¸å¥½çœ‹ï¼

redux çš„ä½œè€…æä¾›äº† Redux Thunk ä¸­é—´ä»¶ç»™æˆ‘ä»¬é›†ä¸­åœ°å¤„ç†å‰¯ä½œç”¨ï¼Œæ‰€ä»¥å®ƒçš„ä¼˜ç‚¹å°±æ˜¯ï¼šå¯ä»¥å¤„ç†å‰¯ä½œç”¨ã€‚

ä½†æ˜¯ä¹Ÿå°±ä»…æä¾›å¤„ç†å‰¯ä½œç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œå¤„ç†æ–¹å¼ç›¸å½“ç²—æš´ç®€é™‹ï¼ˆä½ çœ‹çœ‹ thunk ä¸€å…±å°± 10 è¡Œä¸åˆ°çš„ä»£ç ä½ å°±æ‡‚äº†ï¼‰ï¼Œæˆ‘è¯´è¯´ç¼ºç‚¹ï¼š

- å†…éƒ¨ä»£ç é‡å¤ä¸”æ— æ„ä¹‰ï¼Œé€»è¾‘å¤æ‚ï¼ˆä¸‘ï¼‰
- Action æœ¬åº”æ˜¯ä¸€ä¸ªçº¯ç¢çš„ JS å¯¹è±¡ï¼Œä½†æ˜¯ä½¿ç”¨ Thunk ä¹‹å Action çš„å½¢å¼åƒå¥‡ç™¾æ€ï¼ˆä¸‘ï¼‰
- ä»£ç éš¾ä»¥æµ‹è¯•ï¼ˆå› ä¸ºä¸‘ï¼‰

ä¸¾ä¸ªä¸‘ä¾‹å­

```js
const GET_DATA = "GET_DATA";
const GET_DATA_SUCCESS = "GET_DATA_SUCCESS";
const GET_DATA_FAILED = "GET_DATA_FAILED";

const getDataAction = (id) => (dispatch, getState) => {
  dispatch({
    type: GET_DATA,
    payload: id,
  });
  api
    .getData(id)
    .then((res) => {
      dispatch({
        type: GET_DATA_SUCCESS,
        payload: res,
      });
    })
    .catch((err) => {
      dispatch({
        type: GET_DATA_FAILED,
        payload: err,
      });
    });
};
```

ç»¼ä¸Šï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬é«˜çº§è€Œä¼˜é›…çš„å‰ç«¯å·¥ç¨‹å¸ˆæƒ³è¦çš„ç»“æœï¼ï¼

#### Why Redux Saga

é‚£ä¸ºä»€ä¹ˆå°±æ¨è Saga äº†å‘¢ï¼Ÿ

> é²è¿…è¯´ï¼š ä¼˜é›…ï¼é«˜çº§ï¼ä¸€çœ¼çœ‹ä¸æ‡‚ï¼

æˆ‘ä»¬çœ‹ä¸€ä¸‹å®˜æ–¹ä»‹ç»å§ã€‚

> redux-saga is a library that aims to make application side effects easier to manage, more efficient to execute, easy to test, and better at handling failures.

ä»ä»‹ç»ä¸­å¯ä»¥çœ‹åˆ° Saga æœ‰è¿™ä¹ˆå‡ ä¸ªç‰¹ç‚¹ï¼š

- æ›´å®¹æ˜“ç®¡ç†å‰¯ä½œç”¨
- ç¨‹åºæ›´é«˜æ•ˆæ‰§è¡Œ
- æ˜“äºæµ‹è¯•
- æ˜“äºå¤„ç†é”™è¯¯

é‚£é²è¿…ä¸ºä»€ä¹ˆè¯´äººå®¶ä¼˜é›…é«˜çº§å•Šï¼Œé«˜åœ¨å“ªå„¿å•Šï¼Ÿ

Redux Saga ä¹‹æ‰€ä»¥æ›´å—æˆ‘ä»¬æ¬¢è¿ï¼Œå› ä¸ºå®ƒçš„æ ¸å¿ƒå°±æ˜¯å·§å¦™åœ°ä½¿ç”¨äº† ES6 çš„ç‰¹æ€§â€”â€”Generatorï¼ŒåŸºäº Generator å®ç°å¼‚æ­¥æµç¨‹çš„æ§åˆ¶ç®¡ç†ã€‚

#### ES6 Generator

ä¸ºäº†æ›´å¥½åœ°ç†è§£ Saga çš„åŸç†ï¼Œäº†è§£ Generator çš„åŸºç¡€çŸ¥è¯†æ˜¯å¿…ç»ä¹‹è·¯ã€‚

```js
function* generator() {
  yield "hello";
  yield "world";
}

let gen = generator();

gen.next(); // { value: 'hello', done: false}
gen.next(); // { value: 'world', done: false}
gen.next(); // { value: undefined, done: true}
```

generator æ˜¯ç”Ÿæˆå™¨å‡½æ•°ï¼Œ\*ï¼šæ˜¯å®ƒçš„ä¸“æœ‰æ ‡å¿—ã€‚

yield æ˜¯æš‚åœæ ‡å¿—ï¼Œæ¯æ¬¡ç¨‹åºè¿è¡Œåˆ° yield æ—¶éƒ½ä¼šæš‚åœï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æŒ‡ä»¤çš„æ‰§è¡Œï¼›å®ƒåªèƒ½åœ¨ generator å‡½æ•°é‡Œï¼Œåé¢è·Ÿç€ä¸€ä¸ªè¡¨è¾¾å¼ã€‚

**return æ˜¯ç»ˆæ­¢æ ‡å¿—ã€‚**

gen æ˜¯ç”± generator ç”Ÿæˆå™¨å‡½æ•°ç”Ÿæˆçš„ä¸€ä¸ªéå†å™¨å¯¹è±¡ã€‚

gen å¯¹è±¡æ‹¥æœ‰ next()æ–¹æ³•ï¼Œè°ƒç”¨ next æ–¹æ³•ä¼šå¾—åˆ°ç»“æ„ä¸ºä¸€ä¸ªå†…å« value å’Œ done å±æ€§çš„å¯¹è±¡ï¼Œvalue æ˜¯ yield åé¢è¡¨è¾¾å¼çš„å€¼ï¼Œdone æ˜¯éå†æ˜¯å¦ç»“æŸçš„æ ‡å¿—ä½ã€‚

åªæœ‰æ‰§è¡Œäº† next æ‰ä¼šå¼€å§‹è°ƒç”¨ generator å‡½æ•°ã€‚next ä¼ å…¥çš„å‚æ•°ä¼šå½“ä½œä¸Šä¸€ä¸ª yield è¡¨è¾¾å¼çš„è¿”å›å€¼ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨ next ä¼ å…¥çš„å‚æ•°æ˜¯æ— æ•ˆçš„ã€‚

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå¤æ‚ä¸€ç‚¹ç‚¹çš„ä¾‹å­æ¥äº†è§£ Generator å‡½æ•°

```js
function* generator(x, y) {
  // yield
  // æš‚åœæ ‡å¿—
  // åªèƒ½åœ¨generatoré‡Œ
  // åé¢æ¥ç€ä¸€ä¸ªè¡¨è¾¾å¼
  let a = yield x + y;
  // âš ï¸aæ‹¿åˆ°çš„æ˜¯nextä¼ æ¥çš„å‚æ•°ï¼Œè€Œä¸æ˜¯yieldåé¢çš„è¡¨è¾¾å¼ï¼
  // âš ï¸å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡nextå‡½æ•°åœ¨å¤–éƒ¨æ”¹å˜generatorå†…éƒ¨çš„è¡Œä¸º
  let b = yield x * y;
  // return
  // ç»ˆæ­¢æ ‡å¿—
  return a + b;
}

// gen
// éå†å™¨å¯¹è±¡
let gen = generator(1, 2);

gen.next();
// {value: 3, done: false}
gen.next(9);
// {value: 2, done: false}
gen.next(8);
// {value: 17, done: false}
// åªæœ‰æ‰§è¡Œnextæ‰ä¼šè°ƒç”¨generator
// nextä¼ å…¥çš„å‚æ•°ä¼šå½“ä½œä¸Šä¸€ä¸ªyieldè¡¨è¾¾å¼çš„è¿”å›å€¼
// æ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨nextä¼ å…¥çš„å‚æ•°æ˜¯æ— æ•ˆçš„
```

çœ‹æ‡‚è¿™æ®µä»£ç æœ€å…³é”®çš„ç‚¹å°±æ˜¯

**yield å‰é¢çš„å˜é‡æ‹¿åˆ°çš„æ˜¯ next ä¼ æ¥çš„å‚æ•°ï¼Œè€Œä¸æ˜¯ yield åé¢çš„è¡¨è¾¾å¼ï¼**

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy83MTYyNTgyLTUwNjYzZWI5OWY3MjVmMWEucG5nP2ltYWdlTW9ncjIvYXV0by1vcmllbnQvc3RyaXB8aW1hZ2VWaWV3Mi8yL3cvMTEzMC9mb3JtYXQvd2VicA?x-oss-process=image/format,png)

**Generator é€šè¿‡ yield å’Œ next æ¥ä¼ é€’æ•°æ®æ¥æ§åˆ¶å‡½æ•°çš„å†…éƒ¨æµç¨‹**

#### Redux Saga

å‰é¢é“ºå«äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºè¦å¼€å§‹è®²ä¸€ä¸‹ Saga äº†ã€‚

Saga æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆå½“ç„¶è¦å»æ³¨å†Œä¸€ä¸‹å®ƒ

```js
import { createStore, applyMiddleware } from "redux";
import createSagaMiddleware from "redux-saga";
import reducer from "./reducers";
import mySaga from "./sagas";

// create the saga middleware
const sagaMiddleware = createSagaMiddleware();
// mount it on the Store
const store = createStore(reducer, applyMiddleware(sagaMiddleware));

// then run the saga
sagaMiddleware.run(mySaga);

export default store;
```

æ³¨å†Œçš„æ­¥éª¤å¾ˆç®€å•ï¼Œè°ƒç”¨ createSagaMiddlewareï¼Œç”¨äºåˆ›å»º saga ä¸­é—´ä»¶ï¼›è®² saga ä¸­é—´ä»¶æ³¨å…¥ store ä¸­ï¼Œå¹¶æ‰§è¡Œ run æ“ä½œï¼Œè¿è¡Œæˆ‘ä»¬å†™çš„ saga å‡½æ•°ã€‚

å†æ¥ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š

```typescript
import { createActions } from "redux-actions";
import { call, put, takeLatest } from "redux-saga/effects";
import { fetchDataApi } from "@api/index";

export const {
  data: { fetchDataReq, fetchDataSucc, fetchDataFailed },
} = createActions({
  DATA: {
    FETCH_DATA_REQ: null,
    FETCH_DATA_SUCC: (rsp) => ({ data: rsp }),
    FETCH_DATA_FAILED: null,
  },
});

function* fetchDataReqSaga() {
  try {
    const rsp = yield call(fetchDataApi);
    yield put(fetchDataSucc(rsp));
  } catch (e) {
    yield put(fetchDataFailed(e));
  }
}

function* watchFetchSaga() {
  yield takeLatest(fetchDataReq, fetchDataReqSaga);
}

export default watchFetchSaga;
```

Redux Thunk åŒæ ·çš„å°ä¾‹å­ï¼Œå‘èµ·ä¸€ä¸ª action è§¦å‘ä¸€ä¸ª http è¯·æ±‚ï¼Œè¯·æ±‚æˆåŠŸæ—¶å‘èµ· success actionï¼Œè¯·æ±‚å¤±è´¥æ—¶å‘èµ· failed actionã€‚

åœ¨ Saga ä¸­ä¼šä½¿ç”¨ä¸€ç§å«åš**Effect çš„æŒ‡ä»¤æ¥å®Œæˆè¿™äº›æ“ä½œ**ã€‚
callï¼Œputï¼ŒtakeLatest ç­‰ç­‰ï¼Œéƒ½æ˜¯ Effect æŒ‡ä»¤ã€‚

é€šä¿—åœ°è®²ï¼Œcall ä½œç”¨æ˜¯è°ƒç”¨å…¶å‚æ•°ä¸­çš„å‡½æ•°ï¼Œpull ä½œç”¨æ˜¯å‘èµ·ä¸€ä¸ª actionï¼Œtakelatest ä½œç”¨æ˜¯ç›‘å¬æŸä¸ª action çš„è§¦å‘å¹¶æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚

#### Effects

Effects å°±æ˜¯ç®€å•çš„ JavaScript å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒè§†ä½œæ˜¯å‘é€ç»™ saga middleware çš„ä¸€äº›æŒ‡ä»¤ï¼Œå®ƒä»…ä»…æ˜¯è´Ÿè´£å‘ middleware**æè¿°è°ƒç”¨è¡Œä¸ºçš„ä¿¡æ¯**ï¼Œè€Œæ¥ä¸‹æ¥çš„**æ“ä½œæ˜¯ç”± middleware æ¥æ‰§è¡Œ**ï¼Œ**middleware æ‰§è¡Œå®Œæ¯•åå°†æŒ‡ä»¤çš„ç»“æœå›é¦ˆç»™ Generator**ã€‚

ä¹Ÿå°±æ˜¯è¯´**æˆ‘ä»¬åªéœ€è¦é€šè¿‡å£°æ˜ Effects çš„å½¢å¼ï¼Œå°†å‰¯ä½œç”¨çš„éƒ¨åˆ†éƒ½ç•™ç»™ middleware æ¥æ‰§è¡Œã€‚**

è¿™æ ·åšçš„å¥½å¤„ï¼š
1: é›†ä¸­å¤„ç†å¼‚æ­¥æ“ä½œï¼Œæ›´æµåˆ©ç†Ÿæ‚‰åœ°è¡¨è¾¾å¤æ‚çš„æ§åˆ¶æµã€‚
2: ä¿è¯ action æ˜¯ä¸ªçº¯ç²¹çš„ JavaScript å¯¹è±¡ï¼Œé£æ ¼ä¿æŒç»Ÿä¸€ã€‚
3: å£°æ˜å¼æŒ‡ä»¤ï¼Œæ— éœ€åœ¨ generator ä¸­ç«‹å³æ‰§è¡Œï¼Œåªéœ€é€šçŸ¥ middleware è®©å…¶æ‰§è¡Œï¼›å€ŸåŠ© generator çš„ next æ–¹æ³•ï¼Œå‘å¤–éƒ¨æš´éœ²æ¯ä¸€ä¸ªæ­¥éª¤ã€‚

æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ä¸€äº›å¸¸ç”¨çš„ effect æŒ‡ä»¤

- put ç”¨æ¥å‘½ä»¤ middleware å‘ Store å‘èµ·ä¸€ä¸ª actionã€‚
- take ç”¨æ¥å‘½ä»¤ middleware åœ¨ Store ä¸Šç­‰å¾…æŒ‡å®šçš„ actionã€‚åœ¨å‘èµ·ä¸ pattern åŒ¹é…çš„ action ä¹‹å‰ï¼ŒGenerator å°†æš‚åœã€‚
- call ç”¨æ¥å‘½ä»¤ middleware ä»¥å‚æ•° args è°ƒç”¨å‡½æ•° fnã€‚
- fork ç”¨æ¥å‘½ä»¤ middleware ä»¥ **éé˜»å¡è°ƒç”¨** çš„å½¢å¼æ‰§è¡Œ fnã€‚
- race ç”¨æ¥å‘½ä»¤ middleware åœ¨å¤šä¸ª Effect é—´è¿è¡Œï¼Œç›¸å½“äº Promise.raceã€‚
- all ç”¨æ¥å‘½ä»¤ middleware å¹¶è¡Œåœ°è¿è¡Œå¤šä¸ª Effectï¼Œå¹¶ç­‰å¾…å®ƒ\* ä»¬å…¨éƒ¨å®Œæˆï¼Œç›¸å½“äº Promise.allã€‚

#### Saga è¾…åŠ©å‡½æ•°

Saga é™¤äº†æä¾› Effectsï¼Œè¿˜ä¼šæä¾›ä¸€äº›é«˜é˜¶çš„è¾…åŠ©å‡½æ•°ç»™æˆ‘ä»¬ä½¿ç”¨ï¼Œè€Œè¿™äº›è¾…åŠ©å‡½æ•°å®é™…ä¸Šä¹Ÿæ˜¯åŸºäºå„ä¸ª Effects å®ç°çš„ã€‚

- takeEveryï¼ˆtake+forkï¼‰
- takeLatest ï¼ˆtake+fork+cancelï¼‰
- takeLeadingï¼ˆtake+callï¼‰
- throttleï¼ˆtake+fork+delayï¼‰
- debounceï¼ˆtake+fork+delay)
- retry ï¼ˆcall+delayï¼‰

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®è§¦å‘äº‹ä»¶æ—¶ï¼š

- takeEvery ä¼šå¹¶å‘æ‰§è¡Œï¼ˆtake+forkï¼‰ï¼›
- takeLastest åªæ‰§è¡Œæœ€åä¸€æ¬¡ï¼ˆtake+fork+cancelï¼‰ï¼›
- takeLeading åªæ‰§è¡Œç¬¬ä¸€æ¬¡ï¼ˆtake+callï¼‰ï¼›
- throttle èŠ‚æµï¼Œè§¦å‘åä¸€æ®µæ—¶é—´ä¸ä¼šå†æ¬¡è§¦å‘ï¼ˆtake+fork+delayï¼‰ï¼›
- debounce é˜²æŠ–ï¼Œç­‰åˆ°ä¸€æ®µæ—¶é—´åå†è§¦å‘ï¼›
- retryï¼Œå¤šæ¬¡é‡è¯•è§¦å‘ï¼›

#### Saga åŸç†ä¹‹ Channelï¼ˆå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼‰

äº†è§£å®Œ Saga çš„åŸºæœ¬ä½¿ç”¨ï¼Œæˆ‘ä»¬å¼€å§‹è¿›ä¸€æ­¥äº†è§£å®ƒçš„åŸç†ã€‚å…ˆè¯´è¯´ Saga ä¸­é—´ä»¶é‡Œå¤´æœ‰ä¸€ä¸ª Channel çš„ä¸œè¥¿ï¼Œå®ƒå¯ä»¥ç†è§£ä¸ºä¸€ä¸ª action ç›‘å¬çš„æ± å­ï¼Œæ¯æ¬¡è°ƒç”¨ take æŒ‡ä»¤çš„æ—¶å€™å°±ä¼šå°†å¯¹åº” action çš„ç›‘å¬å‡½æ•°æ”¾è¿›æ± å­é‡Œï¼Œå½“æ¯æ¬¡è°ƒç”¨ put æŒ‡ä»¤æˆ–è€…å¤–éƒ¨å‘èµ·ä¸€ä¸ª action çš„æ—¶å€™ï¼ŒSaga å°±ä¼šåœ¨æ± å­é‡ŒåŒ¹é…å¯¹åº”çš„ç›‘å¬å‡½æ•°å¹¶æ‰§è¡Œï¼Œç„¶åå°†å…¶é”€æ¯ã€‚

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy83MTYyNTgyLTNmYmQ4MGY2Y2ZhMmUxMjUucG5nP2ltYWdlTW9ncjIvYXV0by1vcmllbnQvc3RyaXB8aW1hZ2VWaWV3Mi8yL3cvNzU0L2Zvcm1hdC93ZWJw?x-oss-process=image/format,png)

channel

ä»¥ä¸‹æ˜¯ç®€åŒ–è¿‡çš„ Saga æºç  channel éƒ¨åˆ†ï¼š

```php
function channel () {
  let taker
  function take (cb) {
    taker = cb
  }
  function put (input) {
    if (taker) {
      const tempTaker = taker
      taker = null
      tempTaker(input)
    }
  }
  return {
    put,
    take
  }
}

const chan = channel()
```

#### Saga åŸç†ä¹‹è‡ªé©±åŠ¨æ¨¡å¼

å¯èƒ½ä½ ä¼šæœ‰ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆ Saga ä¸­é—´ä»¶ä¼šè‡ªåŠ¨æŒ‰ç…§ç¨‹åºè®¾å®šçš„ä¸€èˆ¬åœ°æ¥å—æŒ‡å®šçš„ Effect æŒ‡ä»¤å»æ‰§è¡Œå¯¹åº”çš„åŒæ­¥/å¼‚æ­¥æ“ä½œå‘¢ï¼Ÿ

å…¶å®è¿™å°±æ˜¯ Saga åŸºäº Generator çš„ä¸€ç§è‡ªé©±åŠ¨æ¨¡å¼ï¼ˆè¿™æ˜¯æˆ‘è‡ªå·±èµ·çš„åå­—ï¼‰

å›è¿‡å¤´æƒ³æƒ³ä¸Šæ–‡æåŠ Generator æ—¶å½’ç»“å‡ºçš„ä¸€ä¸ªç»“è®ºï¼š

**Generator é€šè¿‡ yield å’Œ next æ¥ä¼ é€’æ•°æ®æ¥æ§åˆ¶å‡½æ•°çš„å†…éƒ¨æµç¨‹**

Saga å°±æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‚¹ï¼Œè€Œä¸”ä¸æ­¢è¿™æ ·ï¼ŒSaga ä¸­é—´ä»¶å†…éƒ¨æœ‰ä¸€ä¸ª**é©±åŠ¨å‡½æ•°**ï¼ˆeffectRunner)ï¼Œå®ƒé‡Œé¢ç”Ÿæˆä¸€ä¸ªéå†å™¨å¯¹è±¡æ¥ä¸æ–­åœ°**æ¶ˆè´¹**ç”Ÿæˆå™¨å‡½æ•°(effectProducer)ä¸­çš„ effect æŒ‡ä»¤ï¼Œå®Œæˆ**æŒ‡å®šçš„ä»»åŠ¡å¹¶é€’å½’å¾ªç¯ä¸‹å»**ã€‚ï¼ˆè¿™æ—¶å€™ä½ å¯èƒ½ä¼šæƒ³åˆ° TJ å¤§ç¥çš„ CO åº“ï¼‰

è¿™ä¸ªé©±åŠ¨å‡½æ•°å¤§æ¦‚é•¿è¿™æ ·

```php
function task (saga) {
  // åˆå§‹åŒ–éå†å™¨å¯¹è±¡
  const sa = saga()
  function next (args) {
      // è·å–åˆ°yieldåé¢çš„è¡¨è¾¾å¼â€”â€”effectæŒ‡ä»¤
      const result = sa.next(args)
      const effect = result.value
      // æ‰§è¡Œeffectå¯¹åº”çš„æ“ä½œâ€”â€”call/put/take...
      runEffect(result.value, next)
  }
  // æ‰§è¡Œnextå‡½æ•°
  next()
}
```

è¿™æ ·å°±å®ç°äº†ä¸€ä¸ªè‡ªæˆ‘é©±åŠ¨çš„æ–¹æ¡ˆï¼Œå›æƒ³ä¸€ä¸‹ Saga ä¸­é—´ä»¶æ³¨å†Œçš„æ­¥éª¤

> è°ƒç”¨ createSagaMiddlewareï¼Œç”¨äºåˆ›å»º saga ä¸­é—´ä»¶ï¼›è®² saga ä¸­é—´ä»¶æ³¨å…¥ store ä¸­ï¼Œå¹¶æ‰§è¡Œ run æ“ä½œï¼Œè¿è¡Œæˆ‘ä»¬å†™çš„ saga å‡½æ•°ã€‚

å½“æ‰§è¡Œ run(saga)çš„æ—¶å€™å…¶å®å°±æ˜¯å¯åŠ¨äº†é©±åŠ¨å‡½æ•°ï¼ˆeffectRunner)ï¼Œå®ƒå¼€å§‹æ§åˆ¶æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ä¸šåŠ¡æµç¨‹ Saga å‡½æ•°(effectProducer)ï¼ŒeffectRunner é€šè¿‡**next æ¥æ§åˆ¶æµç¨‹å’Œä¼ é€’æ•°æ®**ï¼ˆæ‰§è¡Œç»“æœï¼‰ï¼ŒeffectProducer é€šè¿‡**yield æ¥å‘å¸ƒ effect æŒ‡ä»¤**ï¼Œè¿™æ ·å°±å®Œç¾æ¼”ç»äº† saga æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼ï¼

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy83MTYyNTgyLWU4NDZkMmQ5MmU0ZGVhZGYucG5nP2ltYWdlTW9ncjIvYXV0by1vcmllbnQvc3RyaXB8aW1hZ2VWaWV3Mi8yL3cvODE4L2Zvcm1hdC93ZWJw?x-oss-process=image/format,png)

#### Saga æºç 

å®é™…ä¸Š Saga æºç ä¸­ä¹Ÿå°±è¿™ä¹ˆä¸€å›äº‹ï¼Œä¸»è¦æŒ‘äº† channel å’Œè‡ªé©±åŠ¨å‡½æ•°ä¸¤å—ä¸œè¥¿æ¥çœ‹ï¼Œåœ¨ Saga æºç ä¸­æœ‰ä¸€ä¸ª proc å‡½æ•°ï¼Œå…¶å®å°±æ˜¯ä¸Šæ–‡æåˆ°çš„è‡ªé©±åŠ¨å‡½æ•°ï¼Œå®ƒæ¥æ”¶åˆ° effect æŒ‡ä»¤ä¹‹åè¿›è¡Œ effect ç±»å‹åˆ†å‘ï¼Œä¸åŒ effect å¯¹åº”ä¸åŒçš„æ“ä½œã€‚

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy83MTYyNTgyLTFlZjk3OTVkYWYyODMxN2MucG5nP2ltYWdlTW9ncjIvYXV0by1vcmllbnQvc3RyaXB8aW1hZ2VWaWV3Mi8yL3cvMTIwMC9mb3JtYXQvd2VicA?x-oss-process=image/format,png)

#### Saga æµ‹è¯•

Saga è¿˜æœ‰ä¸€ä¸ªä¼˜ç‚¹è®°å¾—å—ï¼Ÿæ˜“äºæµ‹è¯•ï¼Œç”±äºä¸šåŠ¡ä»£ç éƒ½æ˜¯å£°æ˜å¼åœ°è°ƒç”¨ï¼Œè€Œä¸æ˜¯çœŸå®åœ°è¿›è¡Œä¸€äº›å‰¯ä½œç”¨æ“ä½œï¼Œæ‰€ä»¥åœ¨å†™å•æµ‹çš„æ—¶å€™å¯ä»¥é€šè¿‡æ–­è¨€çš„æ–¹å¼æ¥æµ‹è¯•ï¼Œè€Œä¸ç”¨ mock ä¸€äº›ç¹çå¤æ‚çš„æ“ä½œã€‚

### 16.æ‰‹å†™ redux ä¸­é—´ä»¶

#### ç®€å•å®ç°

```js
function createStore(reducer) {
  let currentState;
  let listeners = [];

  function getState() {
    return currentState;
  }

  function dispatch(action) {
    currentState = reducer(currentState, action);
    listeners.map((listener) => {
      listener();
    });
    return action;
  }

  function subscribe(cb) {
    listeners.push(cb);
    return () => {};
  }

  dispatch({ type: "ZZZZZZZZZZ" });

  return {
    getState,
    dispatch,
    subscribe,
  };
}

// åº”ç”¨å®ä¾‹å¦‚ä¸‹ï¼š
function reducer(state = 0, action) {
  switch (action.type) {
    case "ADD":
      return state + 1;
    case "MINUS":
      return state - 1;
    default:
      return state;
  }
}

const store = createStore(reducer);

console.log(store);
store.subscribe(() => {
  console.log("change");
});
console.log(store.getState());
console.log(store.dispatch({ type: "ADD" }));
console.log(store.getState());
```

#### è¿·ä½ ç‰ˆ

```js
export const createStore = (reducer,enhancer)=>{
	if(enhancer) {
		return enhancer(createStore)(reducer)
	}
	let currentState = {}
	let currentListeners = []

	const getState = ()=>currentState
	const subscribe = (listener)=>{
		currentListeners.push(listener)
	}
	const dispatch = action=>{
		currentState = reducer(currentState, action)
		currentListeners.forEach(v=>v())
		return action
	}
	dispatch({type:'@@INIT'})
	return {getState,subscribe,dispatch}
}

//ä¸­é—´ä»¶å®ç°
export applyMiddleWare(...middlewares){
	return createStore=>...args=>{
		const store = createStore(...args)
		let dispatch = store.dispatch

		const midApi = {
			getState:store.getState,
			dispatch:...args=>dispatch(...args)
		}
		const middlewaresChain = middlewares.map(middleware=>middleware(midApi))
		dispatch = compose(...middlewaresChain)(store.dispatch)
		return {
			...store,
			dispatch
		}
	}

// fn1(fn2(fn3())) æŠŠå‡½æ•°åµŒå¥—ä¾æ¬¡è°ƒç”¨
export function compose(...funcs){
	if(funcs.length===0){
		return arg=>arg
	}
	if(funs.length===1){
		return funs[0]
	}
	return funcs.reduce((ret,item)=>(...args)=>ret(item(...args)))
}


//bindActionCreatorå®ç°

function bindActionCreator(creator,dispatch){
    return ...args=>dispatch(creator(...args))
}
function bindActionCreators(creators,didpatch){
    //let bound = {}
    //Object.keys(creators).forEach(v=>{
   //     let creator = creator[v]
     //   bound[v] = bindActionCreator(creator,dispatch)
    //})
    //return bound

    return Object.keys(creators).reduce((ret,item)=>{
	    ret[item] = bindActionCreator(creators[item],dispatch)
    	return ret
    },{})
}
```

### 16.Redux æºç åˆ†æ

[å®ç°ä¸€ä¸ª Reduxï¼ˆå®Œå–„ç‰ˆï¼‰](https://segmentfault.com/a/1190000022641464)

[å¸¦ä½ ä»å¤´åˆ°å°¾ç³»ç»Ÿåœ°æ’¸ä¸€é Redux æºç ](https://juejin.cn/post/6965366315833884680)

![image-20220920221954896](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/image-20220920221954896.png)

types ä¸»è¦å­˜æ”¾çš„æ˜¯ ts å®šä¹‰çš„ä¸€äº›ç±»å‹ï¼Œ utils ä¸»è¦æ˜¯ä¸€äº›é€šç”¨æ–¹æ³•ï¼Œæ²¡ä»€ä¹ˆæ¶‰åŠå…³é”®æµç¨‹çš„ï¼Œæ‰€ä»¥ä¸»è¦åˆ†æ applyMiddleware,combineReducers,compose, createStrore è¿™ 4 ä¸ª ts æ–‡ä»¶

#### CreateStore

```javascript
// å¼•å…¥ redux
import { createStore } from 'redux'

// åˆ›å»º store
const store = createStore(
    reducer,
    initial_state,
    applyMiddleware(middleware1, middleware2, ...)

);
```

ä»å›¾ä¸­ createStore æ¥å— 3 ä¸ªå‚æ•°

- ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ä¸€ä¸ª reducer ä¸€ä¸ªçº¯å‡½æ•° ï¼Œç”±æˆ‘ä»¬è‡ªå·±å®šä¹‰
- ç¬¬äºŒä¸ªå‚æ•° åˆå§‹åŒ–çš„æ•°çŠ¶æ€
- ç¬¬ä¸‰ä¸ªå‚æ•° å…¶å®å°±æ˜¯**åˆ¶å®šä¸­é—´ä»¶ åœ¨æºç ä¸­å°±æ˜¯ enhancer å¢å¼º store**

ä»æ‹¿åˆ°å…¥å‚åˆ°è¿”å›å‡º store çš„è¿‡ç¨‹ä¸­ï¼Œåˆ°åº•éƒ½å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œæ˜¯ createStore ä¸­ä¸»ä½“é€»è¾‘çš„æºç ï¼š

![a79b5992ec074da1bf65a3c30e60d844 (1)](<https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/a79b5992ec074da1bf65a3c30e60d844%20(1).png>)

è¿™æ®µä»£ç ä¸»è¦æ˜¯åšä¸€äº›ç±»å‹åˆ¤æ–­ï¼Œ å’Œä¸€äº›å†™æ³•å…¼å®¹æ²¡ä»€ä¹ˆã€‚ç»§ç»­å¾€ä¸‹çœ‹ï¼Œ ä¸‹é¢æ˜¯ä¸€äº›åˆå§‹çŠ¶æ€çš„èµ‹å€¼ï¼š

![24198c5fdf4343ccb7aa22e5af0965b2](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/24198c5fdf4343ccb7aa22e5af0965b2.png)

æ¥ä¸‹æ¥å°±è¿›å…¥æˆ‘ä»¬ç»å¸¸ç”¨çš„ getState å‡½æ•°äº†ã€‚

#### getState

![96a2787b556e4becb108b4fb0810ec8f](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/96a2787b556e4becb108b4fb0810ec8f.png)

ç»§ç»­å¾€ä¸‹çœ‹

#### subscribe

![dcc54d529c904727ad982a2a185d56d1](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/dcc54d529c904727ad982a2a185d56d1.png)

è¿™é‡Œ**è®¢é˜…çš„æ—¶å€™æµ…æ‹·è´äº†ä¸€ä¸‹ï¼Œå¸è½½çš„æ—¶å€™ä¹Ÿæµ…æ‹·è´**ï¼Œç”¨çš„éƒ½æ˜¯**nextListeners**, è¿˜è®°å¾—æœ‰ä¸ª**currentListeners**ï¼Œæ¥ç€å¾€ä¸‹çœ‹ã€‚

#### dispatch

![64dbac4766484026a7cf805910c63ab8](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/64dbac4766484026a7cf805910c63ab8.png)

dispatch çš„æ—¶å€™ï¼šåˆå°† next é‡æ–°å¤åˆ¶ç»™ currentï¼Œç„¶åæ‰§è¡Œæ¯ä¸ª listenr,çœ‹åˆ°è¿™é‡Œåº”è¯¥æ˜ç™½ reducer ä¸­ dispatch æˆ–è€…åšä¸€äº› subscribe åšä¸€äº›è„æ“ä½œï¼Œredux æºç ä¸­ä¸ºäº†é˜²æ­¢è¿™ç§ å°±æ˜¯è®¾ç½® isDispatching è¿™ä¸ª å˜é‡æ¥æ§åˆ¶ã€‚

æ‰€ä»¥ dispacth ä¸€ä¸ª action? Redux å¸®æˆ‘ä»¬åšäº†å•¥äº‹ï¼Œå°±å¾ˆç®€å• 2 ä»¶äº‹

1.  oldState ç»è¿‡ reducer äº§ç”Ÿäº† newState, æ›´æ–°äº† store æ•°æ®ä¸­å¿ƒ
2.  è§¦å‘è®¢é˜…

æ•´ä¸ª Redux çš„å·¥ä½œæµï¼Œåˆ°è¿™é‡Œå…¶å®å·²ç»ç»“æŸäº†ï¼Œ ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªç–‘é—®å°±æ˜¯ subscribe ä¸ºå•¥éƒ½æ˜¯ nextListeners ç„¶ååœ¨ dispatch ä¸­çš„åˆæŠŠå€¼é‡æ–°èµ‹ç»™ currentListeners?

ç­”æ¡ˆå°±æ˜¯ï¼š**ä¸ºäº†ä¿è¯è§¦å‘è®¢é˜…çš„ç¨³å®šæ€§**

è¿™å¥è¯æ€ä¹ˆç†è§£å‘¢æˆ‘ä¸¾ä¸€ä¸ªä¾‹å­ï¼š

```scss
// å®šä¹‰ç›‘å¬å‡½æ•°a
function listenera() {
}
// è®¢é˜… aï¼Œå¹¶è·å– a çš„è§£ç»‘å‡½æ•°
const unSubscribea = store.subscribe(listenera)
// å®šä¹‰ç›‘å¬å‡½æ•° b
function listenerb() {
  // åœ¨ b ä¸­è§£ç»‘ a
  unSubscribea()
}
// å®šä¹‰ç›‘å¬å‡½æ•° c
function listenerc() {
}
// è®¢é˜… b
store.subscribe(listenerb)
// è®¢é˜… c
store.subscribe(listenerc)
```

ä»ä¸Šæ–‡æˆ‘å¯ä»¥å¾—çŸ¥å½“å‰çš„ currentListeners:

```js
[listenera, listenerb, listenerc];
```

ä½†æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ listenb å…¶å®å¸è½½ listena çš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸æµ…æ‹·è´ä¸€ä¸‹ï¼Œ é‚£ä¹ˆè§¦å‘è®¢é˜…çš„æ—¶å€™æ•°ç»„éå†åˆ° i = 2 çš„æ—¶å€™å…¶å®æ•°ç»„æ˜¯ undefined ï¼Œè¿™æ ·å¼•å‘æŠ¥é”™ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ è®¢é˜…å‰å’Œå¸è½½è®¢é˜…éƒ½æµ…æ‹·è´ä¸€ä¸‹ï¼ŒnextListeners æ•°æ®éšä¾¿æ€ä¹ˆå˜ï¼Œåªè¦ä¿è¯**currentListener ç¨³å®š**å°±å¥½äº†ã€‚

æœ¬æ¬¡ dispacth å®Œä¹‹åï¼Œä¸‹ä¸€æ¬¡ dispacth å‡è®¾æ²¡æœ‰æ–°å¢è®¢é˜…ï¼Œæ•°æ®å…³ç³»åˆé‡æ–°èµ‹å€¼ã€‚

```js
listeners =ï¼ˆ currentListeners = nextListenersï¼‰
```

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Redux è®¢é˜…ç¨³å®šçš„åŸå› äº†ã€‚ æ¥ä¸‹æ¥å°±æ˜¯åˆ†æ Redux çš„ä¸­é—´ä»¶æ¨¡å‹ã€‚

#### Redux ä¸­çš„ä¸­é—´ä»¶æ€æƒ³

è¦æƒ³ç†è§£ redux çš„ä¸­é—´ä»¶æ€æƒ³ï¼Œ æˆ‘ä»¬å…ˆçœ‹ä¸‹ compose è¿™ä¸ªæ–‡ä»¶åšäº†ä»€ä¹ˆï¼Œ è¿™ä¸ªæ–‡ä»¶å…¶å®åšçš„äº‹æƒ…ååˆ†ç®€å•ã€‚ä¸»è¦æ˜¯ç”¨åˆ°å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„ç»„åˆæ¦‚å¿µï¼Œ å°†å¤šä¸ªå‡½æ•°è°ƒç”¨ç»„åˆæˆä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚

å…¶å®ä¸»è¦æ˜¯ reduce çš„è¿™ä¸ª api,ç®€å•æ‰‹å†™ä¸‹æ•°ç»„**reduce** çš„å®ç°ï¼š

![img](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e5ac643fb7354740944219d59d3eb63d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

è¿™ä¸œè¥¿å…¶å®å°±æ˜¯ä¸ªç´¯åŠ å™¨æŒ‰ç…§æŸç§æ–¹å¼ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å°±ç›´æ¥è¿›å…¥ compose å‡½æ•°è¯ä¸å¤šè¯´ç›´æ¥çœ‹ä»£ç ï¼š

```javascript
// å‚æ•°æ˜¯å‡½æ•°æ•°ç»„
export default function compose(...funcs: Function[]) {
  // å¤„ç†è¾¹ç•Œæƒ…å†µ
  if (funcs.length === 0) {
    return <T>(arg: T) => arg;
  }
  // æ•°é‡ä¸º1 å°±æ²¡æœ‰ç»„åˆçš„å¿…è¦äº†
  if (funcs.length === 1) {
    return funcs[0];
  }
  // ä¸»è¦æ˜¯ä¸‹é¢è¿™ä¸€è¡Œä»£ç 
  return funcs.reduce(
    (a, b) =>
      (...args: any) =>
        a(b(...args))
  );
}
```

åˆ†æä¸‹è¿™è¡Œä»£ç ï¼Œä¸¾ä¾‹å­è¯´æ˜ï¼š å‡è®¾æˆ‘ä»¬æœ‰è¿™ä¸ª 3 ä¸ªå‡½æ•°ï¼š

```js
funcs = [fa, fb, fc];
```

ç”±äºæ²¡æœ‰å‡ºåˆå§‹å€¼ç´¯åŠ å™¨çš„å°±æ˜¯ fa ç»è¿‡ä¸€æ¬¡éå†åï¼Œ **accumulateur å˜ä¸ºä¸‹é¢çš„æ ·å­ï¼š**

```js
let  m= ï¼ˆ...argsï¼‰ => fa(fb(...args))
```

åœ¨ç»è¿‡ä¸€æ¬¡éå†åï¼Œæ­¤æ—¶ b = fc æ­¤æ—¶ accumulateur å˜ä¸ºä¸‹é¢çš„æ ·å­ï¼š

```js
ï¼ˆ...argsï¼‰ => m(fc(...args))
```

æˆ‘ä»¬å°† fc(...argsï¼‰ çœ‹åšä¸€ä¸ªæ•´ä½“å¸¦å…¥ä¸Šé¢ m çš„å‡½æ•° æ‰€ä»¥å°±å˜æˆäº†ä¸‹é¢çš„æ ·å­

```js
ï¼ˆ...argsï¼‰=> fa(fb(fc(...args)))
```

åˆ°è¿™é‡Œå°±å¤§å·¥å‘Šæˆäº†ï¼Œfa, fb, fc æˆ‘ä»¬å¯ä»¥æƒ³è±¡æˆ redux çš„ 3 ä¸ªä¸­é—´ä»¶ï¼Œ æŒ‰ç…§é¡ºåºä¼ è¿›å»ï¼Œ

å½“è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™ä¹Ÿä¼šæŒ‰ç…§ fa, fb, fc é¡ºåºè°ƒç”¨ã€‚ æ¥ä¸‹æ¥çœ‹ compose æ˜¯å¦‚ä½•å’Œ Redux åšç»“åˆçš„ã€‚

#### applyMiddleWare

å…ˆæŠŠæ•´ä½“ç»“æ„åˆ†æä¸‹ï¼Œå‡½æ•°å‚æ•°åˆ†ä¸‹ï¼š

```javascript
// applyMiddlerware ä¼šä½¿ç”¨â€œ...â€è¿ç®—ç¬¦å°†å…¥å‚æ”¶æ•›ä¸ºä¸€ä¸ªæ•°ç»„

export default function applyMiddleware(...middlewares) {

  // å®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªæ¥æ”¶ createStore ä¸ºå…¥å‚çš„å‡½æ•°

  return createStore => (...args) => {

    ......

  }

}
```

createStore å°±æ˜¯ ä¸Šé¢æˆ‘ä»¬åˆ†æè¿‡çš„ åˆ›å»ºæ•°æ®ä¸­å¿ƒ Store ,è€Œ args ä¸»è¦æ˜¯æœ‰ä¸¤ä¸ªï¼Œ è¿˜æ˜¯ createStore ä¸¤ä¸ªçº¦å®šå…¥å‚ **ä¸€ä¸ªæ˜¯ reducerï¼Œ ä¸€ä¸ªæ˜¯ initState**ã€‚

#### enhance-dispatch

æ¥ä¸‹æ¥å°±æ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„ï¼Œ æ”¹å†™ dispacth, ä¸ºä»€ä¹ˆè¦æ”¹å†™ dispatch, è¿˜æ˜¯ä¸¾ä¸ªä¾‹å­è¯´æ˜ã€‚ dispacth æ¥å—çš„ action åªèƒ½æ˜¯å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯å¯¹è±¡çš„è¯ä¼šç›´æ¥æŠ¥ç±»å‹é”™è¯¯ã€‚å¦‚å›¾ï¼š

![image-20220920224351438](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/image-20220920224351438.png)

ç¤¾åŒºæ¯”è¾ƒæœ‰åçš„ redux-thunk ä¸­é—´ä»¶ï¼Œ dispatch å¯ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œ

```js
åº”ç”¨äº†ä¸­é—´ä»¶çš„dispatch å’Œ æ²¡æœ‰ç”¨ä¸­é—´çš„dispatch è‚¯å®šæ˜¯ä¸ç­‰çš„ï¼Œ
dispatch = enhancer(dispacth) è‚¯å®šæ˜¯å¢å¼ºçš„è‡³äºæ€ä¹ˆä¸ªå¢å¼ºæ³• ç»§ç»­å¾€ä¸‹çœ‹ã€‚
const store = createStore(...args)
let chain = []
const middlewareAPI = {
    getState: store.getState,
    dispatch: (...args) => dispatch(...args)
}
chain = middlewares.map(middleware => middleware(middlewareAPI)) // ç»‘å®š {dispatchå’ŒgetState}
dispatch = compose(...chain)(store.dispatch)
```

ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°çš„ç¬¬ä¸€æ­¥ å…¶å®å°±æ˜¯å°† getState å’Œ dispatch ä½œä¸ºä¸­é—´ä»¶ä¸­çš„é—­åŒ…ä½¿ç”¨ï¼Œ æœ‰äººä¼šè¿™é‡Œæé—®ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆæ˜¯åŒ¿åå‡½æ•° ? è€Œä¸æ˜¯ store.dispatch ?

ä¸¾ä¸ªä¾‹å­è¯´æ˜ï¼Œä¸Šé¢çš„ fa , fb, fc æ¥ä¸‹æ¥æŠŠä»–ä»¬å±•å¼€ã€‚

```js
function fa(store) {
  return function (next) {
    return function (action) {
      console.log("A middleware1 å¼€å§‹");
      next(action);
      console.log("B middleware1 ç»“æŸ");
    };
  };
}

function fb(store) {
  return function (next) {
    return function (action) {
      console.log("C middleware2 å¼€å§‹");
      next(action);
      console.log("D middleware2 ç»“æŸ");
    };
  };
}

function fc(store) {
  return function (next) {
    return function (action) {
      console.log("E middleware3 å¼€å§‹");
      next(action);
      console.log("F middleware3 ç»“æŸ");
    };
  };
}
```

ok æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åˆ†æï¼Œ çœ‹åˆ°åº•åšäº†ä»€ä¹ˆã€‚

```js
chain = middlewares.map((middleware) => middleware(middlewareAPI));
```

å¾ˆæ˜¾ç„¶ æˆ‘ä»¬ çš„ middlewares = [fa, fb, fc],map ä¹‹åè¿”å›ä¸€ä¸ªæ–°çš„ chain è¿™æ—¶å€™çš„ chain åº”è¯¥æ˜¯ä¸‹é¢ è¿™æ ·å­çš„ï¼š

`chain = [ (next)=>(action)=>{...}, (next) => (action) => {...}, (next) => (action) => {...} ]`

**åªä¸è¿‡ chain ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´  éƒ½æœ‰ getSateï¼Œdispatch çš„é—­åŒ…è€Œå·²**ã€‚

ç»§ç»­å¾€ä¸‹èµ°å°±åˆ°äº† compose å‡½æ•° è¿˜è®°å¾—ä¸Šé¢ compose(fa, fb, fc ) è¿”å›å€¼æ˜¯ä»€ä¹ˆï¼Ÿ

**ï¼ˆ...argsï¼‰=> fa(fb(fc(...args)))**

å°±æ˜¯è¿™ä¸ªä¸œè¥¿ï¼Œè¿™é‡Œçš„ chain ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œ æ‰€ä»¥è¿™é‡Œçš„ dispatch å°±å˜æˆäº†å¢å¼ºçš„ dispatch,ä¸€èµ·çœ‹ä¸‹

```js
dispatch = fa(fb(fc(store.dispacth)));
```

çœ‹åˆ°è¿™é‡Œæœ‰äººå°±é—®ï¼Ÿ æ¯ä¸€ä¸ªä¸­é—´ä»¶çš„ next å’Œ åŸå…ˆçš„ store.dispacth æœ‰ä»€ä¹ˆä¸åŒ ï¼Ÿ è¿™å’Œæ´‹è‘±æ¨¡å‹æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

é‚£æˆ‘å°±å¸¦ä½ ä¸€æ­¥ä¸€æ­¥åˆ†æ, è¿™é‡Œçš„ dispatch å°±æ˜¯æŒ‡çš„æ˜¯å½“å‰çš„ fa(fb(fc(store.dispatch))) , æˆ‘ä»¬å¯ä»¥ç›´æ¥å‡½æ•°è°ƒç”¨æ¥åˆ†æï¼Œ

fa çš„å‚æ•° æ˜¯ **fb(fc(store.dispatch)) , ç”±äºä¾èµ– fb, æ‰€ä»¥è°ƒç”¨ fb, ç„¶åå‘ç° fb ä¾èµ–çš„å‚æ•°æ˜¯ fc(store.dispacth), ç´§æ¥ç€åˆå¼€å§‹è°ƒç”¨ fc, ok åˆ°è¿™é‡Œç»ˆäºç»“æŸäº†ï¼Œ ç»ˆäºæ²¡æœ‰ä¾èµ–äº†ã€‚ æ‰€ä»¥ä»ä¸Šé¢çš„è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥å¾—åˆ° next å…¶å®æ˜¯ä»–ä¸Šä¸ªä¸­é—´ä»¶çš„å‰¯ä½œç”¨ï¼Œ æœ€åä¸€ä¸ªä¸­é—´ä»¶çš„ next å°±æ˜¯ store.dispatchã€‚**

> **å‰¯ä½œç”¨ï¼š æ¯ä¸ªä¸­é—´ä»¶çš„ä¸­çš„ ï¼ˆaction ï¼‰=> {...}**

æˆ‘ç”¨æµç¨‹å›¾è¡¨ç¤ºæ•´ä¸ªæ´‹è‘±æ¨¡å‹æµç¨‹ï¼š

![image-20220920224733879](https://femarkdownpicture.oss-cn-qingdao.aliyuncs.com/Imgs/image-20220920224733879.png)

å½“æˆ‘è°ƒç”¨ dispatch çš„æ—¶å€™ï¼Œ å…ˆæ‰“å° E, ç„¶åå‘ç° next æ˜¯å‰¯ä½œç”¨ fb, ç„¶åè°ƒç”¨å‰¯ä½œç”¨ fb, æ‰“å° cï¼Œå‘ç° next ç«Ÿç„¶æ˜¯ å‰¯ä½œç”¨ fc ,å†å»è°ƒç”¨ fc, æ‰“å° Aï¼Œ next è¿™æ—¶å€™å°±æ˜¯ store.dispacth, è°ƒç”¨ç»“æŸï¼Œ æ‰“å° b, ç„¶åæ‰“å° Dï¼Œ æœ€åæ‰“å° F ã€‚ è¿™æ ·çš„ä¸€ç³»åˆ—æ“ä½œæ˜¯ä¸æ˜¯æœ‰ç‚¹åƒæ´‹è‘±æ¨¡å‹ï¼Œå¯¹äºä¹‹å‰æå‡ºçš„é—®é¢˜ï¼Ÿ

> 1.ä¸ºä»€ä¹ˆ dispacth æ˜¯åŒ¿åå‡½æ•°ï¼Ÿ

> 2.ä¸ºä»€ä¹ˆ dispacth ä¸€ä¸ª action åï¼Œ è¿˜æ˜¯è¿”å› action

**é—®é¢˜ 1**ï¼š ä¸ºä»€ä¹ˆ dispatch æ˜¯æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œå› ä¸ºæœ‰çš„ä¸­é—´ä»¶åŸç†çš„å®ç°ï¼Œå¹¶ä¸ä¼š next(action), è¿™æ—¶å€™éœ€è¦è‚¯å®šæ˜¯å¢å¼ºçš„ dispacthï¼Œ redux-thunk çš„æ‰§è¡ŒåŸç†ï¼Œ å°±æ˜¯å½“ä½ ä¼ é€’ä¸€ä¸ªå‡½æ•°ï¼Œ ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶æŠŠ dispatch çš„ æƒé™ äº¤ç»™ä½ è‡ªå·±å¤„ç†ã€‚

```javascript
function createThunkMiddleware(extraArgument) {
  return ({ dispatch, getState }) =>
    (next) =>
    (action) => {
      if (typeof action === "function") {
        // è¿™ä¸ªçš„dispatch å…¶å®æ˜¯å¢å¼ºçš„dispatchï¼Œ
        // å¦‚æœç”¨store.dispatchå¦‚æœè¿˜æœ‰å…¶ä»–ä¸­é—´ä»¶å°±ä¸¢å¤±äº†      return action(dispatch, getState, extraArgument);
      }

      return next(action);
    };
}
```

**è¿™é‡Œçœ‹ä¸‹æºç ï¼š**

```js
let dispatch: Dispatch = () => {
	 throw new Error('Dispatching while constructing your middleware is not allowed. ' + 'Other middleware would not be applied to this dispatch.')
}
const middlewareAPI: MiddlewareAPI = {
	getState: store.getState, dispatch: (action, ...args) => dispatch(action, ...args)
}
const chain = middlewares.map(middleware => middleware(middlewareAPI))
// compose å®Œä¹‹åå°†é—­åŒ…æ›´æ–°æˆå¢å¼ºçš„
dispatchdispatch = compose < typeof dispatch > (...chain) (store.dispatch)
```

**æ‰€ä»¥ Redux ä¸¥æ ¼ æ„ä¹‰ä¸Š å¹¶ä¸ç®—æ˜¯æ´‹è‘±æ¨¡å‹ï¼Œ ä»–çš„æ´‹è‘±æ¨¡å‹æ˜¯å»ºç«‹åœ¨ä½ çš„æ¯ä¸ªä¸­é—´ä»¶ï¼Œéƒ½è¦ next(action); å¦‚æœä¸ next(action) å…¶å®å°±ç ´åäº†æ´‹è‘±æ¨¡å‹ã€‚**

**é—®é¢˜ 2ï¼š** dispatch (action) è¿”å› action, å°±æ˜¯ä¸ºäº†æ–¹ä¾¿ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„å¤„ç†ã€‚

### 17.React-Redux æºç 

[ã€Œæºç è§£æã€ä¸€æ–‡åƒé€ react-redux æºç ï¼ˆuseMemo ç»å…¸æºç çº§æ¡ˆä¾‹ï¼‰](https://juejin.cn/post/6937491452838559781)
